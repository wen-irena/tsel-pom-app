import*as Utilities from"./Utilities.js";import CEState from"./CustomElementState.js";export default class CustomElementInternals{constructor(){this._localNameToDefinition=new Map,this._constructorToDefinition=new Map,this._patches=[],this._hasPatches=!1}setDefinition(t,e){this._localNameToDefinition.set(t,e),this._constructorToDefinition.set(e.constructor,e)}localNameToDefinition(t){return this._localNameToDefinition.get(t)}constructorToDefinition(t){return this._constructorToDefinition.get(t)}addPatch(t){this._hasPatches=!0,this._patches.push(t)}patchTree(t){this._hasPatches&&Utilities.walkDeepDescendantElements(t,t=>this.patch(t))}patch(t){if(this._hasPatches&&!t.__CE_patched){t.__CE_patched=!0;for(let e=0;e<this._patches.length;e++)this._patches[e](t)}}connectTree(t){const e=[];Utilities.walkDeepDescendantElements(t,t=>e.push(t));for(let t=0;t<e.length;t++){const n=e[t];n.__CE_state===CEState.custom?this.connectedCallback(n):this.upgradeElement(n)}}disconnectTree(t){const e=[];Utilities.walkDeepDescendantElements(t,t=>e.push(t));for(let t=0;t<e.length;t++){const n=e[t];n.__CE_state===CEState.custom&&this.disconnectedCallback(n)}}patchAndUpgradeTree(t,e={}){const n=e.visitedImports||new Set,i=e.upgrade||(t=>this.upgradeElement(t)),a=[];if(Utilities.walkDeepDescendantElements(t,t=>{if("link"===t.localName&&"import"===t.getAttribute("rel")){const e=t.import;e instanceof Node&&(e.__CE_isImportDocument=!0,e.__CE_hasRegistry=!0),e&&"complete"===e.readyState?e.__CE_documentLoadHandled=!0:t.addEventListener("load",()=>{const e=t.import;if(e.__CE_documentLoadHandled)return;e.__CE_documentLoadHandled=!0;const a=new Set(n);a.delete(e),this.patchAndUpgradeTree(e,{visitedImports:a,upgrade:i})})}else a.push(t)},n),this._hasPatches)for(let t=0;t<a.length;t++)this.patch(a[t]);for(let t=0;t<a.length;t++)i(a[t])}upgradeElement(t){if(void 0!==t.__CE_state)return;const e=t.ownerDocument;if(!(e.defaultView||e.__CE_isImportDocument&&e.__CE_hasRegistry))return;const n=this.localNameToDefinition(t.localName);if(!n)return;n.constructionStack.push(t);const i=n.constructor;try{try{if(new i!==t)throw new Error("The custom element constructor did not produce the element being upgraded.")}finally{n.constructionStack.pop()}}catch(e){throw t.__CE_state=CEState.failed,e}if(t.__CE_state=CEState.custom,t.__CE_definition=n,n.attributeChangedCallback){const e=n.observedAttributes;for(let n=0;n<e.length;n++){const i=e[n],a=t.getAttribute(i);null!==a&&this.attributeChangedCallback(t,i,null,a,null)}}Utilities.isConnected(t)&&this.connectedCallback(t)}connectedCallback(t){const e=t.__CE_definition;e.connectedCallback&&e.connectedCallback.call(t)}disconnectedCallback(t){const e=t.__CE_definition;e.disconnectedCallback&&e.disconnectedCallback.call(t)}attributeChangedCallback(t,e,n,i,a){const s=t.__CE_definition;s.attributeChangedCallback&&s.observedAttributes.indexOf(e)>-1&&s.attributeChangedCallback.call(t,e,n,i,a)}};