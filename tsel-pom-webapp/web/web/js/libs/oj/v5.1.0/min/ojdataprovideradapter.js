"use strict";define(["ojs/ojcore","jquery","ojs/ojeventtarget","ojs/ojdataprovider"],function(t,e){var i=function(){function e(t){this.tableDataSource=t,this._KEY="key",this._KEYS="keys",this._AFTERKEYS="afterKeys",this._DIRECTION="direction",this._STARTINDEX="startIndex",this._ATTRIBUTE="attribute",this._SILENT="silent",this._SORT="sort",this._SORTCRITERIA="sortCriteria",this._PAGESIZE="pageSize",this._DATA="data",this._METADATA="metadata",this._INDEXES="indexes",this._OFFSET="offset",this._REFRESH="refresh",this._SIZE="size",this._VALUE="value",this._DONE="done",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._RESULTS="results",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._FETCHTYPE="fetchType",this.AsyncIterable=function(t,e){this._parent=t,this._asyncIterator=e,this[Symbol.asyncIterator]=function(){return this._asyncIterator}},this.AsyncIterator=function(){function t(t,e,i){this._parent=t,this._nextFunc=e,this._params=i,this._fetchFirst=!0}return t.prototype.next=function(){var t=this._fetchFirst;return this._fetchFirst=!1,this._nextFunc(this._params,t)},t}(),this.AsyncIteratorResult=function(t,e,i){this._parent=t,this.value=e,this.done=i,this[t._VALUE]=e,this[t._DONE]=i},this.FetchByKeysResults=function(t,e,i){this._parent=t,this.fetchParameters=e,this.results=i,this[t._FETCHPARAMETERS]=e,this[t._RESULTS]=i},this.ContainsKeysResults=function(t,e,i){this._parent=t,this.containsParameters=e,this.results=i,this[t._CONTAINSPARAMETERS]=e,this[t._RESULTS]=i},this.FetchListResult=function(t,e,i,n){this._parent=t,this.fetchParameters=e,this.data=i,this.metadata=n,this[t._FETCHPARAMETERS]=e,this[t._DATA]=i,this[t._METADATA]=n},this.Item=function(t,e,i){this._parent=t,this.metadata=e,this.data=i,this[t._METADATA]=e,this[t._DATA]=i},this.ItemMetadata=function(t,e){this._parent=t,this.key=e,this[t._KEY]=e},this.FetchByOffsetResults=function(t,e,i,n){this._parent=t,this.fetchParameters=e,this.results=i,this.done=n,this[t._FETCHPARAMETERS]=e,this[t._RESULTS]=i,this[t._DONE]=n},this.FetchListParameters=function(t,e,i){this._parent=t,this.size=e,this.sortCriteria=i,this[t._SIZE]=e,this[t._SORTCRITERIA]=i},this.SortCriterion=function(t,e,i){this._parent=t,this.attribute=e,this.direction=i,this[t._ATTRIBUTE]=e,this[t._DIRECTION]=i},this.DataProviderMutationEventDetail=function(t,e,i,n){this._parent=t,this.add=e,this.remove=i,this.update=n,this[t._ADD]=e,this[t._REMOVE]=i,this[t._UPDATE]=n},this.DataProviderOperationEventDetail=function(t,e,i,n,a){this._parent=t,this.keys=e,this.metadata=i,this.data=n,this.indexes=a,this[t._KEYS]=e,this[t._METADATA]=i,this[t._DATA]=n,this[t._INDEXES]=a},this.DataProviderAddOperationEventDetail=function(t,e,i,n,a,s){this._parent=t,this.keys=e,this.afterKeys=i,this.metadata=n,this.data=a,this.indexes=s,this[t._KEYS]=e,this[t._AFTERKEYS]=i,this[t._METADATA]=n,this[t._DATA]=a,this[t._INDEXES]=s},this._addTableDataSourceEventListeners(),this[this._OFFSET]=0}return e.prototype.destroy=function(){this._removeTableDataSourceEventListeners()},e.prototype.containsKeys=function(t){var e=this,i=[];return t[this._KEYS].forEach(function(t){i.push(e.tableDataSource.get(t))}),Promise.all(i).then(function(i){var n=new Set;return i.map(function(t){null!=t&&n.add(t[e._KEY])}),Promise.resolve(new e.ContainsKeysResults(e,t,n))})},e.prototype.fetchByKeys=function(t){var e=this,i=[];return t[this._KEYS].forEach(function(t){i.push(e.tableDataSource.get(t))}),Promise.all(i).then(function(i){var n=new Map;return i.map(function(t){var i=t[e._KEY],a=t[e._DATA];n.set(i,new e.Item(e,new e.ItemMetadata(e,i),a))}),Promise.resolve(new e.FetchByKeysResults(e,t,n))})},e.prototype.fetchByOffset=function(t){var e=this,i=null!=t?t[this._SIZE]:-1,n=null!=t?t[this._SORTCRITERIA]:null,a=null!=t&&t[this._OFFSET]>0?t[this._OFFSET]:0,s=new this.FetchListParameters(this,i,n);return this._startIndex=0,this._getFetchFunc(s,a)(s,!0).then(function(i){var n=i[e._VALUE],a=i[e._DONE],s=n[e._DATA],r=n[e._METADATA].map(function(t){return t[e._KEY]}),h=new Array;return s.map(function(t,i){h.push(new e.Item(e,new e.ItemMetadata(e,r[i]),s[i]))}),new e.FetchByOffsetResults(e,t,h,a)})},e.prototype.fetchFirst=function(t){return this._isPagingModelTableDataSource()||(this._startIndex=0),new this.AsyncIterable(this,new this.AsyncIterator(this,this._getFetchFunc(t),t))},e.prototype.getCapability=function(t){return t==this._SORT&&"full"==this.tableDataSource.getCapability(t)?{attributes:"multiple"}:null},e.prototype.getTotalSize=function(){return Promise.resolve(this.tableDataSource.totalSize())},e.prototype.isEmpty=function(){return this.tableDataSource.totalSize()>0?"no":"yes"},e.prototype.getPage=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPage():-1},e.prototype.setPage=function(t,e){return this._isPagingModelTableDataSource()?this.tableDataSource.setPage(t,e):Promise.reject(null)},e.prototype.getStartItemIndex=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getStartItemIndex():-1},e.prototype.getEndItemIndex=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getEndItemIndex():-1},e.prototype.getPageCount=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPageCount():-1},e.prototype.totalSize=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSize():-1},e.prototype.totalSizeConfidence=function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSizeConfidence():null},e.prototype._getFetchFunc=function(t,e){var i=this;if(null!=t&&null!=t[this._SORTCRITERIA]){var n=t[this._SORTCRITERIA][0][this._ATTRIBUTE],a=t[this._SORTCRITERIA][0][this._DIRECTION];return this._ignoreSortEvent=!0,this._isPagingModelTableDataSource()||(this._startIndex=0),function(t,n){return function(a,s){if(s){var r={};return r[i._KEY]=t,r[i._DIRECTION]=n,i[i._OFFSET]=0,i.tableDataSource.sort(r).then(function(){return i._ignoreSortEvent=!1,i._getTableDataSourceFetch(a,e)(a)})}return i._getTableDataSourceFetch(a,e)(a)}}(n,a)}return this._getTableDataSourceFetch(t,e)},e.prototype._getTableDataSourceFetch=function(t,e){var i=this;return function(t,n){var a={};if(e=e>0?e:0,null!=i._startIndex&&(a[i._STARTINDEX]=i._startIndex+e),a[i._PAGESIZE]=null!=t&&t[i._SIZE]>0?t[i._SIZE]:null,i._isPagingModelTableDataSource()||(a[i._SILENT]=!0),null!=i.tableDataSource[i._SORTCRITERIA]&&null==t[i._SORTCRITERIA]){t[i._SORTCRITERIA]=[];var s=new i.SortCriterion(i,i.tableDataSource[i._SORTCRITERIA][i._KEY],i.tableDataSource[i._SORTCRITERIA][i._DIRECTION]);t[i._SORTCRITERIA].push(s)}return a[i._FETCHTYPE]=t[i._FETCHTYPE],i._isFetching=!0,new Promise(function(e,n){i._fetchResolveFunc=e,i._fetchRejectFunc=n,i._fetchParams=t,i._requestEventTriggered||i.tableDataSource.fetch(a).then(function(n){if(null!==n){i._isFetching=!1,void 0===n&&((n={})[i._KEYS]=[],n[i._DATA]=[]);var s=[];null!=n[i._KEYS]&&(s=n[i._KEYS].map(function(t){return new i.ItemMetadata(i,t)})),null==i._startIndex&&(i._startIndex=0);var r=!1;i._startIndex=i._startIndex+n[i._DATA].length,"actual"==i.tableDataSource.totalSizeConfidence()&&i.tableDataSource.totalSize()>0&&i._startIndex>=i.tableDataSource.totalSize()?r=!0:a[i._PAGESIZE]>0&&n[i._DATA].length<a[i._PAGESIZE]?r=!0:0==n[i._DATA].length&&(r=!0),i._fetchResolveFunc=null,i._fetchParams=null,e(new i.AsyncIteratorResult(i,new i.FetchListResult(i,t,n[i._DATA],s),r))}},function(t){n(t)})})}},e.prototype._handleSync=function(e){var i=this;if(i._startIndex=null,e[i._STARTINDEX]>0&&(i._startIndex=e[i._STARTINDEX],i[i._OFFSET]=i._startIndex),i._fetchResolveFunc&&null!=e[i._KEYS]){i._isFetching=!1;var n=e[i._KEYS].map(function(t){return new i.ItemMetadata(i,t)}),a=!1;"actual"==i.tableDataSource.totalSizeConfidence()&&i.tableDataSource.totalSize()>0&&i._startIndex>=i.tableDataSource.totalSize()&&(a=!0),i._fetchResolveFunc(new i.AsyncIteratorResult(i,new i.FetchListResult(i,i._fetchParams,e[i._DATA],n),a)),i._fetchResolveFunc=null,i._fetchParams=null}else i._requestEventTriggered||i.dispatchEvent(new t.DataProviderRefreshEvent);i._requestEventTriggered=!1},e.prototype._handleAdd=function(e){var i=this,n=e[i._KEYS].map(function(t){return new i.ItemMetadata(i,t)}),a=new Set;e[i._KEYS].map(function(t){a.add(t)});var s=new i.DataProviderAddOperationEventDetail(i,a,null,n,e[i._DATA],e[i._INDEXES]),r=new i.DataProviderMutationEventDetail(i,s,null,null);i.dispatchEvent(new t.DataProviderMutationEvent(r))},e.prototype._handleRemove=function(e){var i=this,n=e[i._KEYS].map(function(t){return new i.ItemMetadata(i,t)}),a=new Set;e[i._KEYS].map(function(t){a.add(t)});var s=new i.DataProviderOperationEventDetail(i,a,n,e[i._DATA],e[i._INDEXES]),r=new i.DataProviderMutationEventDetail(i,null,s,null);i.dispatchEvent(new t.DataProviderMutationEvent(r))},e.prototype._handleReset=function(e){this._requestEventTriggered||this._isPagingModelTableDataSource()||(this._startIndex=0,this.dispatchEvent(new t.DataProviderRefreshEvent))},e.prototype._handleSort=function(e){this._ignoreSortEvent||(this._startIndex=null,this.dispatchEvent(new t.DataProviderRefreshEvent))},e.prototype._handleChange=function(e){var i=this,n=e[i._KEYS].map(function(t){return new i.ItemMetadata(i,t)}),a=new Set;e[i._KEYS].map(function(t){a.add(t)});var s=new i.DataProviderOperationEventDetail(i,a,n,e[i._DATA],e[i._INDEXES]),r=new i.DataProviderMutationEventDetail(i,null,null,s);i.dispatchEvent(new t.DataProviderMutationEvent(r))},e.prototype._handleRefresh=function(e){this._isFetching||this._requestEventTriggered||(null!=e[this._OFFSET]?this._startIndex=e[this._OFFSET]:this._startIndex=null,this.dispatchEvent(new t.DataProviderRefreshEvent)),this._requestEventTriggered=!1},e.prototype._handleRequest=function(e){void 0!==t.Model&&e instanceof t.Model||this._isFetching||(e[this._STARTINDEX]>0&&0==this.getStartItemIndex()&&(this._startIndex=e[this._STARTINDEX]),this._requestEventTriggered=!0,this.dispatchEvent(new t.DataProviderRefreshEvent))},e.prototype._handleError=function(t){this._fetchRejectFunc&&this._fetchRejectFunc(t),this._isFetching=!1,this._requestEventTriggered=!1},e.prototype._handlePage=function(e){this._isFetching=!1,this._requestEventTriggered=!1;var i={};i.detail=e,this.dispatchEvent(new t.GenericEvent(t.PagingModel.EventType.PAGE,i))},e.prototype._addListener=function(t,e){this._eventHandlerFuncs[t]=e.bind(this),this.tableDataSource.on(t,this._eventHandlerFuncs[t])},e.prototype._removeListener=function(t){this.tableDataSource.off(t,this._eventHandlerFuncs[t])},e.prototype._addTableDataSourceEventListeners=function(){this._eventHandlerFuncs={},this._addListener("sync",this._handleSync),this._addListener("add",this._handleAdd),this._addListener("remove",this._handleRemove),this._addListener("reset",this._handleReset),this._addListener("sort",this._handleSort),this._addListener("change",this._handleChange),this._addListener("refresh",this._handleRefresh),this._addListener("request",this._handleRequest),this._addListener("error",this._handleError),this._addListener("page",this._handlePage)},e.prototype._removeTableDataSourceEventListeners=function(){this._removeListener("sync"),this._removeListener("add"),this._removeListener("remove"),this._removeListener("reset"),this._removeListener("sort"),this._removeListener("change"),this._removeListener("refresh"),this._removeListener("request"),this._removeListener("error"),this._removeListener("page")},e.prototype._isPagingModelTableDataSource=function(){return null!=this.tableDataSource.getStartItemIndex},e}();t.EventTargetMixin.applyMixin(i),t.TableDataSourceAdapter=i,t.TableDataSourceAdapter=i});