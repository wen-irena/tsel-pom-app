"use strict";define(["ojs/ojcore","promise","ojs/ojcustomelement","ojs/ojcomposite-knockout"],function(e){e.Composite={},e.Composite.getMetadata=function(t){var o=e.Composite.getComponentMetadata(t);return o?Promise.resolve(o):null},e.Composite.getComponentMetadata=function(t){var o=e.BaseCustomElementBridge.getRegistered(t);return o&&o.composite?e.BaseCustomElementBridge.__GetDescriptor(t)[e.BaseCustomElementBridge.DESC_KEY_META]:null},e.Composite.register=function(t,o){e.CompositeElementBridge.register(t,o)},e.Composite.getContainingComposite=function(t,o){for(var r=null;t;)if((t=e.CompositeTemplateRenderer.getEnclosingComposite(t))&&"oj-module"!==t.nodeName.toLowerCase()){if(o&&!(16&t.compareDocumentPosition(o)))break;r=t}return r},e.Composite.getBindingProviderName=function(t){return t?t[e.Composite.__BINDING_PROVIDER]:null},e.Composite.__COMPOSITE_PROP="__oj_composite",e.Composite.__BINDING_PROVIDER="__oj_binding_prvdr",e.CompositeElementBridge={},e.CompositeElementBridge.proto=Object.create(e.BaseCustomElementBridge.proto),e.CollectionUtils.copyInto(e.CompositeElementBridge.proto,{beforePropertyChangedEvent:function(t,o,r){var i={property:o};e.CollectionUtils.copyInto(i,r,void 0,!0),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"propertyChanged",[i])},AddComponentMethods:function(t){var o=function(t,o,r,i,n,s){if(!o.SaveEarlyPropertySet(r,i)){var a=o.SetProperty(t,r,i,n,s);a.propertySet&&a.isSubproperty&&e.CompositeElementBridge._getPropertyTracker(o,a.property).valueHasMutated()}};t.setProperty=function(t,r){var i=e.BaseCustomElementBridge.getInstance(this);o(this,i,t,r,this,!0)},t.getProperty=function(t){return e.BaseCustomElementBridge.getInstance(this).GetProperty(this,t,this)},t._propsProto.setProperty=function(e,t){o(this._ELEMENT,this._BRIDGE,e,t,this,!1)},t._propsProto.getProperty=function(e){return this._BRIDGE.GetProperty(this,e,this)},t.getNodeBySubId=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getNodeBySubId?r.getNodeBySubId(t,o._getNodeBySubId.bind(this)):o._getNodeBySubId.bind(this)(t)},t.getSubIdByNode=function(t){var o=e.BaseCustomElementBridge.getInstance(this),r=o._getViewModel(this);return r.getSubIdByNode?r.getSubIdByNode(t,o._getSubIdByNode.bind(this)):o._getSubIdByNode.bind(this)(t)}},CreateComponent:function(t){var o={},r=e.BaseCustomElementBridge.getSlotMap(t,!0);for(var i in r)o[i]=r[i].length;this._SLOT_MAP=r;var n={element:t,props:Promise.resolve(this._PROPS),properties:this._PROPS,slotNodeCounts:Promise.resolve(o),slotCounts:o,unique:e.BaseCustomElementBridge.__GetUnique()};n.uniqueId=t.id?t.id:n.unique,this._VM_CONTEXT=n;var s=e.BaseCustomElementBridge.__GetDescriptor(t.tagName)[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL];s="function"==typeof s?new s(n):e.CompositeTemplateRenderer.invokeViewModelMethod(s,"initialize",[n])||s,this._VIEW_MODEL=s;var a=this;(e.CompositeTemplateRenderer.invokeViewModelMethod(s,"activated",[n])||Promise.resolve(!0)).then(function(r){var i={props:a._PROPS,slotMap:a._SLOT_MAP,slotNodeCounts:o,unique:a._VM_CONTEXT.unique,uniqueId:a._VM_CONTEXT.uniqueId,viewModel:a._VIEW_MODEL,viewModelContext:a._VM_CONTEXT};Object.defineProperty(t,e.Composite.__BINDING_PROVIDER,{value:"knockout"}),e.Components&&e.Components.unmarkPendingSubtreeHidden(t);var n=e.BaseCustomElementBridge.__GetCache(t.tagName),s=e.CompositeElementBridge._getDomNodes(n.view,t);e.CompositeTemplateRenderer.renderTemplate(i,t,s),a.__READY_TO_FIRE=!0,a.resolveDelayedReadyPromise()}).catch(function(e){a._throwError(t,e)})},DefineMethodCallback:function(t,o,r){t[o]=function(){var t=r.internalName||o,i=e.BaseCustomElementBridge.getInstance(this)._getViewModel(this);return i[t].apply(i,arguments)}},DefinePropertyCallback:function(t,o,r){var i=function(t,i){if(!this._BRIDGE.SaveEarlyPropertySet(o,t)){var n=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,o),s=n.peek();if(!e.BaseCustomElementBridge.__CompareOptionValues(o,r,t,s)&&(i&&(t=this._BRIDGE.ValidatePropertySet(this._ELEMENT,o,t)),r._eventListener&&this._BRIDGE.SetEventListenerProperty(this._ELEMENT,o,t),n(t),!r._derived)){var a=i?"external":"internal";e.BaseCustomElementBridge.__FirePropertyChangeEvent(this._ELEMENT,o,t,s,a)}}},n=function(t){var i=e.CompositeElementBridge._getPropertyTracker(this._BRIDGE,o),n=t?i.peek():i();return void 0===n&&(n=r.value,Array.isArray(n)?n=n.slice():"object"==typeof n&&(n=e.CollectionUtils.copyInto({},n,void 0,!0)),i(n)),n};r._derived||e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t._propsProto,o,function(){return n.bind(this,!1)()},function(e){i.bind(this)(e,!1)}),e.BaseCustomElementBridge.__DefineDynamicObjectProperty(t,o,function(){var t=e.BaseCustomElementBridge.getInstance(this);return n.bind(t._PROPS,!0)()},function(t){var o=e.BaseCustomElementBridge.getInstance(this);i.bind(o._PROPS)(t,!0)})},GetMetadata:function(e){return e._metadata},HandleDetached:function(t){e.BaseCustomElementBridge.proto.HandleDetached.call(this,t),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"detached",[t]),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"disconnected",[t])},HandleReattached:function(t){e.BaseCustomElementBridge.proto.HandleReattached.call(this,t),e.CompositeTemplateRenderer.invokeViewModelMethod(this._VIEW_MODEL,"connected",[this._VM_CONTEXT])},InitializeElement:function(t){e.BaseCustomElementBridge.proto.InitializeElement.call(this,t),e.Components&&e.Components.markPendingSubtreeHidden(t);var o=e.BaseCustomElementBridge.__GetCache(t.tagName);if(!o.view){var r=e.BaseCustomElementBridge.__GetDescriptor(t.tagName)[e.BaseCustomElementBridge.DESC_KEY_VIEW];o.view||("string"==typeof r&&(o.view=e.CompositeElementBridge._getDomNodes(r,t)),o.view=r)}if(!o.css){var i=e.BaseCustomElementBridge.__GetDescriptor(t.tagName)[e.BaseCustomElementBridge.DESC_KEY_CSS];if(i){var n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=i:n.appendChild(document.createTextNode(i)),document.head.appendChild(n),o.css=!0}}e.BaseCustomElementBridge.__InitProperties(t,this._PROPS)},InitializePrototype:function(t){e.BaseCustomElementBridge.proto.InitializePrototype.call(this,t),Object.defineProperty(t,"_propsProto",{value:{}})},InitializeBridge:function(t){e.BaseCustomElementBridge.proto.InitializeBridge.call(this,t),t._propsProto&&(this._PROPS=Object.create(t._propsProto),this._PROPS._BRIDGE=this,this._PROPS._ELEMENT=t)},_getNodeBySubId:function(t){var o=e.CompositeElementBridge.__GetSubIdMap(this)[t.subId];if(o){if(o.alias){var r=e.CollectionUtils.copyInto({},t,void 0,!0);r.subId=o.alias;var i=o.node;return i.getNodeBySubId?i.getNodeBySubId(r):e.Components.__GetWidgetConstructor(i)("getNodeBySubId",r)}return o.node}return null},_getSubIdByNode:function(t){if(!this.contains(t))return null;var o=e.CompositeElementBridge.__GetNodeMap(this),r=e.Composite.getContainingComposite(t,this);if(null!=r){var i;if((i=o[a=r.node.getAttribute("data-oj-subid-map")])&&r.getSubIdByNode&&(d=r.getSubIdByNode(t))){var n=i.map[d.subId];return d.subId=n,d}return null}for(var s=t;s!==this;){var a;if(a=s.getAttribute("data-oj-subid-map")||s.getAttribute("data-oj-subid"))break;s=s.parentNode}if(i=o[a]){if(!i.map)return{subId:a};var d,m=i.node;if(d=m.getSubIdByNode?m.getSubIdByNode(t):e.Components.__GetWidgetConstructor(m)("getSubIdByNode",t))return d.subId=i.map[d.subId],d}return null},_getViewModel:function(e){return this._VIEW_MODEL||this._throwError(e,"Cannot access methods before element is upgraded."),this._VIEW_MODEL}}),e.CompositeElementBridge.register=function(t,o){var r={};if(r[e.BaseCustomElementBridge.DESC_KEY_META]=e.CompositeElementBridge._getResource(o,e.BaseCustomElementBridge.DESC_KEY_META),r[e.BaseCustomElementBridge.DESC_KEY_VIEW]=e.CompositeElementBridge._getResource(o,e.BaseCustomElementBridge.DESC_KEY_VIEW),r[e.BaseCustomElementBridge.DESC_KEY_CSS]=e.CompositeElementBridge._getResource(o,e.BaseCustomElementBridge.DESC_KEY_CSS),r[e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL]=e.CompositeElementBridge._getResource(o,e.BaseCustomElementBridge.DESC_KEY_VIEW_MODEL),r[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN]=o[e.BaseCustomElementBridge.DESC_KEY_PARSE_FUN],e.BaseCustomElementBridge.__Register(t,r,e.CompositeElementBridge.proto,!0)){var i=r[e.BaseCustomElementBridge.DESC_KEY_META];if(i){var n=i.name;n?t!=n&&e.Logger.warn("Warning registering composite %s. Registered name: %s does not match name: %s provided in metadata.",t,t,n):e.Logger.warn('Warning registering composite %s. Required property "name" missing from metadata.',t),i.version||e.Logger.warn('Warning registering composite %s. Required property "version" missing from metadata.',t),i.jetVersion||e.Logger.warn('Warning registering composite %s. Required composite "jetVersion" missing from metadata.',t)}else e.Logger.warn("Composite registered'"+t.toLowerCase()+"' without Metadata."),i={};if(null==r[e.BaseCustomElementBridge.DESC_KEY_VIEW])throw new Error("Cannot register composite '"+t.toLowerCase()+"' without a View.");r._metadata=e.BaseCustomElementBridge.__ProcessEventListeners(i,!1),customElements.define(t.toLowerCase(),e.CompositeElementBridge.proto.getClass(r))}},e.CompositeElementBridge._getDomNodes=function(t,o){if("string"==typeof t)return e.__HtmlUtils.stringToNodeArray(t);if(e.CompositeElementBridge._isDocumentFragment(t)){for(var r=t.cloneNode(!0),i=[],n=0;n<r.childNodes.length;n++)i.push(r.childNodes[n]);return i}if(Array.isArray(t)){for(r=[],n=0;n<t.length;n++)r.push(t[n].cloneNode(!0));return r}e.BaseCustomElementBridge.getInstance(o)._throwError(o,"The composite View is not one of the following supported types: string, Array of DOM nodes, DocumentFragment")},e.CompositeElementBridge._generateSubIdMap=function(t,o){if(!t._SUBID_MAP){for(var r={},i={},n=o.children,s=0;s<n.length;s++)e.CompositeElementBridge._walkSubtree(r,i,n[s]);t._NODE_MAP=i,t._SUBID_MAP=r}},e.CompositeElementBridge._walkSubtree=function(t,o,r){if(!r.hasAttribute("slot")&&(e.CompositeElementBridge._addNodeToSubIdMap(t,o,r),!e.BaseCustomElementBridge.getRegistered(r.tagName)&&!e.Components.__GetWidgetConstructor(r)))for(var i=r.children,n=0;n<i.length;n++)e.CompositeElementBridge._walkSubtree(t,o,i[n])},e.CompositeElementBridge._addNodeToSubIdMap=function(e,t,o){var r=o.getAttribute("data-oj-subid"),i=o.getAttribute("data-oj-subid-map");if(i){var n=JSON.parse(i);if("object"==typeof n&&!(n instanceof Array)){var s=n,a={};for(var d in s)e[d]={alias:s[d],node:o},a[s[d]]=d;t[i]={map:a,node:o}}}else r&&(e[r]={node:o},t[r]={node:o})},e.CompositeElementBridge.__GetSubIdMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._SUBID_MAP},e.CompositeElementBridge.__GetNodeMap=function(t){var o=e.BaseCustomElementBridge.getInstance(t);return e.CompositeElementBridge._generateSubIdMap(o,t),o._NODE_MAP},e.CompositeElementBridge._getPropertyTracker=function(t,o){return t._TRACKERS||(t._TRACKERS={}),t._TRACKERS[o]||(t._TRACKERS[o]=e.CompositeTemplateRenderer.createTracker()),t._TRACKERS[o]},e.CompositeElementBridge._getResource=function(e,t){var o=e[t];if(null!=o){if(o.hasOwnProperty("inline"))return o.inline;if(o.hasOwnProperty("promise"))throw new Error("The 'promise' resource type for descriptor key '"+t+"' is no longer supported. The resource should be passed directly as the value instead.");return o}},e.CompositeElementBridge._isDocumentFragment=function(e){return window.DocumentFragment?e instanceof DocumentFragment:e&&11===e.nodeType}});