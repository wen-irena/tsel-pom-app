import{Pos}from"../line/pos.js";import{prepareMeasureForLine,measureCharPrepared,wrappedLineExtentChar}from"../measurement/position_measurement.js";import{getBidiPartAt,getOrder}from"../util/bidi.js";import{findFirst,lst,skipExtendingChars}from"../util/misc.js";function moveCharLogically(e,t,r){let n=skipExtendingChars(e.text,t+r,r);return n<0||n>e.text.length?null:n}export function moveLogically(e,t,r){let n=moveCharLogically(e,t.ch,r);return null==n?null:new Pos(t.line,n,r<0?"after":"before")};export function endOfLine(e,t,r,n,l){if(e){let e=getOrder(r,t.doc.direction);if(e){let o,i=l<0?lst(e):e[0],a=l<0==(1==i.level)?"after":"before";if(i.level>0||"rtl"==t.doc.direction){let e=prepareMeasureForLine(t,r);o=l<0?r.text.length-1:0;let n=measureCharPrepared(t,e,o).top;o=findFirst(r=>measureCharPrepared(t,e,r).top==n,l<0==(1==i.level)?i.from:i.to-1,o),"before"==a&&(o=moveCharLogically(r,o,1))}else o=l<0?i.to:i.from;return new Pos(n,o,a)}}return new Pos(n,l<0?r.text.length:0,l<0?"before":"after")};export function moveVisually(e,t,r,n){let l=getOrder(t,e.doc.direction);if(!l)return moveLogically(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");let o=getBidiPartAt(l,r.ch,r.sticky),i=l[o];if("ltr"==e.doc.direction&&i.level%2==0&&(n>0?i.to>r.ch:i.from<r.ch))return moveLogically(t,r,n);let a,f=(e,r)=>moveCharLogically(t,e instanceof Pos?e.ch:e,r),s=r=>e.options.lineWrapping?(a=a||prepareMeasureForLine(e,t),wrappedLineExtentChar(e,t,a,r)):{begin:0,end:t.text.length},c=s("before"==r.sticky?f(r,-1):r.ch);if("rtl"==e.doc.direction||1==i.level){let e=1==i.level==n<0,t=f(r,e?1:-1);if(null!=t&&(e?t<=i.to&&t<=c.end:t>=i.from&&t>=c.begin)){let n=e?"before":"after";return new Pos(r.line,t,n)}}let u=(e,t,n)=>{let o=(e,t)=>t?new Pos(r.line,f(e,1),"before"):new Pos(r.line,e,"after");for(;e>=0&&e<l.length;e+=t){let r=l[e],i=t>0==(1!=r.level),a=i?n.begin:f(n.end,-1);if(r.from<=a&&a<r.to)return o(a,i);if(a=i?r.from:f(r.to,-1),n.begin<=a&&a<n.end)return o(a,i)}},d=u(o+n,n,c);if(d)return d;let h=n>0?c.end:f(c.begin,-1);return null==h||n>0&&h==t.text.length||!(d=u(n>0?0:l.length-1,n,s(h)))?null:d};