define(["./persistenceManager","./persistenceUtils","./impl/logger"],function(e,t,n){"use strict";function r(e,r){var a=r.headers.get("Expires"),i=r.headers.get("x-oracle-jscpt-cache-expiration-date");return!a||!t.isCachedResponse(r)||i&&0!=i.length||(r.headers.set("x-oracle-jscpt-cache-expiration-date",a),n.log("Offline Persistence Toolkit cacheStrategies: Set x-oracle-jscpt-cache-expiration-date header based on HTTP Expires header")),Promise.resolve(r)}function a(e,r){var a=o(r.headers,"max-age");if(null!=a&&t.isCachedResponse(r)){var i=e.headers.get("Date");i||(i=(new Date).toUTCString());var s=new Date(i).getTime(),c=new Date(s+1e3*a);r.headers.set("x-oracle-jscpt-cache-expiration-date",c.toUTCString()),n.log("Offline Persistence Toolkit cacheStrategies: Set x-oracle-jscpt-cache-expiration-date header based on HTTP max-age header")}return Promise.resolve(r)}function i(r,a){var i=r.headers.get("If-Match"),s=r.headers.get("If-None-Match");if(i||s){if(e.isOnline())return c(r,a,!1);var o=a.headers.get("ETag");if(i&&o.indexOf(i)<0)return t.responseToJSON(a).then(function(e){return e.status=412,e.statusText="If-Match failed due to no matching ETag while offline",n.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 412 based on ETag and HTTP If-Match header"),t.responseFromJSON(e)});if(s&&o.indexOf(s)>=0)return t.responseToJSON(a).then(function(e){return e.status=412,e.statusText="If-None-Match failed due to matching ETag while offline",n.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 412 based on ETag and HTTP If-None-Match header"),t.responseFromJSON(e)})}return Promise.resolve(a)}function s(e,r){return null!=o(r.headers,"no-store")?(t.isCachedResponse(r)&&r.headers.delete("x-oracle-jscpt-cache-expiration-date"),n.log("Offline Persistence Toolkit cacheStrategies: Has HTTP no-store header"),Promise.resolve(r)):l(e,r)}function o(e,t){var n=e.get("Cache-Control");if(n){var r,a,i,s=n.split(",");for(r=0;r<s.length;r++)if(0===(a=s[r].trim()).indexOf(t))return!((i=a.split("=")).length>1)||i[1].trim()}return null}function c(r,a,i){return t.isCachedResponse(a)?e.isOnline()?e.browserFetch(r).then(function(t){return 304==t.status?a:e.getCache().delete(r).then(function(){return n.log("Offline Persistence Toolkit cacheStrategies: Removing old entry based on HTTP revalidation"),t})}):i?t.responseToJSON(a).then(function(e){return e.status=504,e.statusText="cache-control: must-revalidate failed due to application being offline",n.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 504 based HTTP revalidation"),t.responseFromJSON(e)}):Promise.resolve(a):Promise.resolve(a)}function l(r,a){if(null==a||t.isCachedResponse(a)||"GET"!=r.method&&"HEAD"!=r.method)return Promise.resolve(a);var i=a.clone();return e.getCache().put(r,a).then(function(){return n.log("Offline Persistence Toolkit cacheStrategies: Cached Request/Response"),i})}return{getHttpCacheHeaderStrategy:function(){return function(e,t){return r(0,t).then(function(t){return a(e,t)}).then(function(t){return i(e,t)}).then(function(t){return function(e,t){if(o(t.headers,"must-revalidate")){var r=t.headers.get("x-oracle-jscpt-cache-expiration-date");if(r){var a=new Date(r).getTime();if((new Date).getTime()>a)return n.log("Offline Persistence Toolkit cacheStrategies: Handling revalidation HTTP must-revalidate header"),c(e,t,!0)}}return Promise.resolve(t)}(e,t)}).then(function(t){return function(e,t){return function(e,t){if(o(t.headers,"no-cache"))return n.log("Offline Persistence Toolkit cacheStrategies: Has HTTP no-cache header"),!0;var r=e.headers.get("Pragma"),a=r&&"no-cache"===r.trim();return a&&n.log("Offline Persistence Toolkit cacheStrategies: Has HTTP Pragma no-cache header"),a}(e,t)?c(e,t):Promise.resolve(t)}(e,t)}).then(function(t){return s(e,t)})}}}});