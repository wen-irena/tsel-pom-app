define("fetchStrategies",["./persistenceManager","./persistenceUtils","./impl/defaultCacheHandler","./impl/logger"],function(e,n,t,r){"use strict";function o(n,t,o){return new Promise(function(i,a){r.log("Offline Persistence Toolkit fetchStrategies: Process queryParams for Request"),function(e,n){var t=function(e){var n=null;return null!=e.queryHandler&&(n=e.queryHandler),n}(n);return null==t?Promise.resolve():t(e,n)}(n,t).then(function(t){t?(i(t.clone()),s(n,o)):(r.log("Offline Persistence Toolkit fetchStrategies: Response for queryParams is not null"),function(n){return e.getCache().match(n)}(n).then(function(t){t?(r.log("Offline Persistence Toolkit fetchStrategies: Cached Response is not null"),i(t),s(n,o)):(r.log("Offline Persistence Toolkit fetchStrategies: Cached Response is null"),e.browserFetch(n).then(function(e){var t=e.clone();i(t),o&&o(n,e)},function(e){i(new Response(null,{status:503,statusText:"No cached response exists"}))}))}))})})}function s(t,o){o&&(r.log("Offline Persistence Toolkit fetchStrategies: Fetch for ServerResponseCallback"),e.browserFetch(t).then(function(e){n._cloneResponse(e,{url:t.url}).then(function(e){o(t,e)})}))}return{getCacheFirstStrategy:function(s){var i=(s=s||{}).serverResponseCallback,a="disabled"==s.backgroundFetch;return a&&(i=null),!i&&!a&&(i=function(e,n){return Promise.resolve(n)}),function(s,a){if(r.log("Offline Persistence Toolkit fetchStrategies: Processing CacheFirstStrategy"),i)var l=function(r,o){var s=n.buildEndpointKey(r);t.registerEndpointOptions(s,a);var l={};return n._cloneResponse(o,{url:r.url}).then(function(e){return i(r,e)}).then(function(n){return l.resolvedResponse=n,e.getCache().hasMatch(r)}).then(function(t){var o=l.resolvedResponse.clone();return t?null==l.resolvedResponse||n.isCachedResponse(l.resolvedResponse)||"GET"!=r.method&&"HEAD"!=r.method?o:e.getCache().put(r,l.resolvedResponse).then(function(){return o}):o}).then(function(e){return t.unregisterEndpointOptions(s),Promise.resolve(e)})};return o(s,a,l)}},getCacheIfOfflineStrategy:function(){return function(t,s){return r.log("Offline Persistence Toolkit fetchStrategies: Processing CacheIfOfflineStrategy"),e.isOnline()?e.browserFetch(t).then(function(e){return e.ok?n._cloneResponse(e,{url:t.url}):function(e,n,t){return n.status<500?(r.log("Offline Persistence Toolkit fetchStrategies: Response is not ok"),Promise.resolve(n)):o(e,t)}(t,e,s)},function(e){return r.log(e),o(t,s)}):o(t,s)}}}}),define("cacheStrategies",["./persistenceManager","./persistenceUtils","./impl/logger"],function(e,n,t){"use strict";function r(e,r){var o=r.headers.get("Expires"),s=r.headers.get("x-oracle-jscpt-cache-expiration-date");return o&&n.isCachedResponse(r)&&(!s||0==s.length)&&(r.headers.set("x-oracle-jscpt-cache-expiration-date",o),t.log("Offline Persistence Toolkit cacheStrategies: Set x-oracle-jscpt-cache-expiration-date header based on HTTP Expires header")),Promise.resolve(r)}function o(e,r){var o=a(r.headers,"max-age");if(null!=o&&n.isCachedResponse(r)){var s=e.headers.get("Date");s||(s=(new Date).toUTCString());var i=new Date(s).getTime(),l=new Date(i+1e3*o);r.headers.set("x-oracle-jscpt-cache-expiration-date",l.toUTCString()),t.log("Offline Persistence Toolkit cacheStrategies: Set x-oracle-jscpt-cache-expiration-date header based on HTTP max-age header")}return Promise.resolve(r)}function s(r,o){var s=r.headers.get("If-Match"),i=r.headers.get("If-None-Match");if(s||i){if(e.isOnline())return l(r,o,!1);var a=o.headers.get("ETag");if(s&&a.indexOf(s)<0)return n.responseToJSON(o).then(function(e){return e.status=412,e.statusText="If-Match failed due to no matching ETag while offline",t.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 412 based on ETag and HTTP If-Match header"),n.responseFromJSON(e)});if(i&&a.indexOf(i)>=0)return n.responseToJSON(o).then(function(e){return e.status=412,e.statusText="If-None-Match failed due to matching ETag while offline",t.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 412 based on ETag and HTTP If-None-Match header"),n.responseFromJSON(e)})}return Promise.resolve(o)}function i(e,r){return null!=a(r.headers,"no-store")?(n.isCachedResponse(r)&&r.headers.delete("x-oracle-jscpt-cache-expiration-date"),t.log("Offline Persistence Toolkit cacheStrategies: Has HTTP no-store header"),Promise.resolve(r)):u(e,r)}function a(e,n){var t=e.get("Cache-Control");if(t){var r,o,s,i=t.split(",");for(r=0;r<i.length;r++)if(0===(o=i[r].trim()).indexOf(n))return!((s=o.split("=")).length>1)||s[1].trim()}return null}function l(r,o,s){return n.isCachedResponse(o)?e.isOnline()?e.browserFetch(r).then(function(n){return 304==n.status?o:e.getCache().delete(r).then(function(){return t.log("Offline Persistence Toolkit cacheStrategies: Removing old entry based on HTTP revalidation"),n})}):s?n.responseToJSON(o).then(function(e){return e.status=504,e.statusText="cache-control: must-revalidate failed due to application being offline",t.log("Offline Persistence Toolkit cacheStrategies: Returning Response status 504 based HTTP revalidation"),n.responseFromJSON(e)}):Promise.resolve(o):Promise.resolve(o)}function u(r,o){if(null==o||n.isCachedResponse(o)||"GET"!=r.method&&"HEAD"!=r.method)return Promise.resolve(o);var s=o.clone();return e.getCache().put(r,o).then(function(){return t.log("Offline Persistence Toolkit cacheStrategies: Cached Request/Response"),s})}return{getHttpCacheHeaderStrategy:function(){return function(e,n){return r(0,n).then(function(n){return o(e,n)}).then(function(n){return s(e,n)}).then(function(n){return function(e,n){if(a(n.headers,"must-revalidate")){var r=n.headers.get("x-oracle-jscpt-cache-expiration-date");if(r){var o=new Date(r).getTime(),s=(new Date).getTime();if(s>o)return t.log("Offline Persistence Toolkit cacheStrategies: Handling revalidation HTTP must-revalidate header"),l(e,n,!0)}}return Promise.resolve(n)}(e,n)}).then(function(n){return function(e,n){return function(e,n){if(a(n.headers,"no-cache"))return t.log("Offline Persistence Toolkit cacheStrategies: Has HTTP no-cache header"),!0;var r=e.headers.get("Pragma"),o=r&&"no-cache"===r.trim();return o&&t.log("Offline Persistence Toolkit cacheStrategies: Has HTTP Pragma no-cache header"),o}(e,n)?l(e,n):Promise.resolve(n)}(e,n)}).then(function(n){return i(e,n)})}}}}),define("defaultResponseProxy",["./persistenceManager","./persistenceUtils","./fetchStrategies","./cacheStrategies","./persistenceStoreManager","./impl/defaultCacheHandler","./impl/logger"],function(e,n,t,r,o,s,i){"use strict";function a(e){null==(e=e||{}).fetchStrategy&&(e.fetchStrategy=t.getCacheIfOfflineStrategy()),null==e.cacheStrategy&&(e.cacheStrategy=r.getHttpCacheHeaderStrategy()),e.requestHandlerOverride=e.requestHandlerOverride||{},null==e.requestHandlerOverride.handleGet&&(e.requestHandlerOverride.handleGet=this.handleGet),null==e.requestHandlerOverride.handlePost&&(e.requestHandlerOverride.handlePost=this.handlePost),null==e.requestHandlerOverride.handlePut&&(e.requestHandlerOverride.handlePut=this.handlePut),null==e.requestHandlerOverride.handlePatch&&(e.requestHandlerOverride.handlePatch=this.handlePatch),null==e.requestHandlerOverride.handleDelete&&(e.requestHandlerOverride.handleDelete=this.handleDelete),null==e.requestHandlerOverride.handleHead&&(e.requestHandlerOverride.handleHead=this.handleHead),null==e.requestHandlerOverride.handleOptions&&(e.requestHandlerOverride.handleOptions=this.handleOptions),Object.defineProperty(this,"_options",{value:e})}function l(n){if(!e.isOnline()){return Promise.resolve(new Response(null,{status:503,statusText:"Must provide handlePost override for offline"}))}return e.browserFetch(n)}function u(e,n){var t=e;return(0,t._options.fetchStrategy)(n,t._options)}function c(n,t){var r=n;return e.isOnline()?e.browserFetch(t.clone()).then(function(e){return e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for default PUT Handler"),e):g(r,t,e,f)},function(e){return f(r,t)}):f(r,t)}function f(e,t){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing offline logic for default PUT Handler"),n.requestToJSON(t).then(function(e){e.status=200,e.statusText="OK",e.headers["content-type"]="application/json",e.headers["x-oracle-jscpt-cache-expiration-date"]="";var t=e.headers["if-match"],r=e.headers["if-none-match"];if(t||r){i.log("Offline Persistence Toolkit DefaultResponseProxy: Generating ETag for offline Response for default PUT Handler");var o=Math.floor(1e6*Math.random());e.headers.etag=(Date.now()+o).toString(),e.headers["x-oracle-jscpt-etag-generated"]=e.headers.etag,delete e.headers["if-match"],delete e.headers["if-none-match"]}return n.responseFromJSON(e)})}function h(n,t){var r=n;return e.isOnline()?e.browserFetch(t.clone()).then(function(e){return e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for default DELETE Handler"),e):g(r,t,e,d)},function(e){return d(r,t)}):d(r,t)}function d(e,t){var r=e;return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing offline logic for default DELETE Handler"),n.requestToJSON(t).then(function(e){return e.status=200,e.statusText="OK",e.headers["content-type"]="application/json",e.headers["x-oracle-jscpt-cache-expiration-date"]="",n.responseFromJSON(e).then(function(s){var i=function(e){var n=e.url.split("/");return n[n.length-1]}(t),a=null;return r._options&&r._options.jsonProcessor&&r._options.jsonProcessor.shredder&&(a=r._options.jsonProcessor.shredder),a?a(s).then(function(t){if(t){var r=t[0].name;return o.openStore(r).then(function(t){return t.findByKey(i).then(function(t){return t?n.responseFromJSON(e).then(function(e){return n.setResponsePayload(e,t).then(function(e){return e})}):s})})}return s}):s})})}function g(e,n,t,r){var o=e;return t.status<500?Promise.resolve(t):r(o,n)}function p(n,t,r){return!e.isOnline()||r?e.getSyncManager().insertRequest(n,{undoRedoDataArray:t}):Promise.resolve()}function P(n,t){return"GET"==n.method||"HEAD"==n.method?e.getCache().hasMatch(n,{ignoreSearch:!0}).then(function(e){return e?v(n,t):Promise.resolve()}):v(n,t)}function v(e,n){return s.constructShreddedData(e,n).then(function(n){return n?function(e,n){var t=[];return n.forEach(function(n){var r=Object.keys(n)[0];t.push(function(e,n,t){return function(e,n,t){var r,s,i=[],a=function(t,l){return t<l.length&&"GET"!==e.method&&"HEAD"!==e.method?(r=l[t].key.toString(),s="DELETE"!==e.method?l[t].value:null,o.openStore(n).then(function(e){return e.findByKey(r).then(function(e){return i.push({key:r,undo:e,redo:s}),a(++t,l)},function(e){return i.push({key:r,undo:null,redo:s}),a(++t,l)})})):Promise.resolve(i)};return a(0,t)}(e,n,t).then(function(r){return"DELETE"===e.method?function(e,n,t){return o.openStore(e).then(function(e){return e.removeByKey(n[0].key)}).then(function(){return t.length>0?{storeName:e,operation:"remove",undoRedoData:t}:null})}(n,t,r):function(e,n,t){return o.openStore(e).then(function(e){return e.upsertAll(n)}).then(function(){return t.length>0?{storeName:e,operation:"upsert",undoRedoData:t}:null})}(n,t,r)})}(e,r,n[r]))}),Promise.all(t)}(e,n):Promise.resolve()})}return a.prototype.getFetchEventListener=function(){var e=this;return function(n){n.respondWith(e.processRequest(n.request))}},a.prototype.processRequest=function(e){var t=this,r=n.buildEndpointKey(e);return new Promise(function(o,a){s.registerEndpointOptions(r,t._options);var l=function(e,n){var t=e._options,r=null;return"POST"===n.method?r=t.requestHandlerOverride.handlePost:"GET"===n.method?r=t.requestHandlerOverride.handleGet:"PUT"===n.method?r=t.requestHandlerOverride.handlePut:"PATCH"===n.method?r=t.requestHandlerOverride.handlePatch:"DELETE"===n.method?r=t.requestHandlerOverride.handleDelete:"HEAD"===n.method?r=t.requestHandlerOverride.handleHead:"OPTIONS"===n.method&&(r=t.requestHandlerOverride.handleOptions),r}(t,e),u={},c=e.clone();i.log("Offline Persistence Toolkit DefaultResponseProxy: Calling requestHandler for request with enpointKey: "+r),l.call(t,e).then(function(o){return n.isCachedResponse(o)&&(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is cached for request with enpointKey: "+r),u.isCachedResponse=!0),o.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for request with enpointKey: "+r),function(e,n,t){var r=e;return"GET"===n.method||"HEAD"===n.method?(0,r._options.cacheStrategy)(n,t,r._options):Promise.resolve(t)}(t,e,o)):(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is not ok for request with enpointKey: "+r),o)}).then(function(n){return u.response=n,n.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok after cacheStrategy for request with enpointKey: "+r),P(e,n)):(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is not ok after cacheStrategy for request with enpointKey: "+r),null)}).then(function(n){return p(e,n,u.isCachedResponse)}).then(function(){s.unregisterEndpointOptions(r),o(u.response)}).catch(function(e){i.log("Offline Persistence Toolkit DefaultResponseProxy: Insert Response in syncManager after error for request with enpointKey: "+r),p(c,null,!0).then(function(){s.unregisterEndpointOptions(r),a(e)},function(){s.unregisterEndpointOptions(r),a(e)})})})},a.prototype.handlePost=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default POST Handler"),l(e)},a.prototype.handleGet=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default GET Handler"),u(this,e)},a.prototype.handleHead=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default HEAD Handler"),u(this,e)},a.prototype.handleOptions=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default OPTIONS Handler"),l(e)},a.prototype.handlePut=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default PUT Handler"),c(this,e)},a.prototype.handlePatch=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default PATCH Handler"),l(e)},a.prototype.handleDelete=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default DELETE Handler"),h(this,e)},{getResponseProxy:function(e){return new a(e)}}}),define("simpleJsonShredding",["./persistenceUtils","./impl/logger"],function(e,n){"use strict";return{getShredder:function(e,t){return function(r){n.log("Offline Persistence Toolkit simpleJsonShredding: Shredding Response");var o=r.clone(),s=o.headers.get("Etag");return o.text().then(function(r){var o=[],i=[],a="collection";if(r&&r.length>0)try{var l=JSON.parse(r);Array.isArray(l)?(o=l.map(function(e){return e[t]}),i=l):(o[0]=l[t],i[0]=l,a="single")}catch(e){n.log("Offline Persistence Toolkit simpleRestJsonShredding: Error during shredding: "+e)}return[{name:e,resourceIdentifier:s,keys:o,data:i,resourceType:a}]})}},getUnshredder:function(){return function(t,r){return n.log("Offline Persistence Toolkit simpleJsonShredding: Unshredding Response"),Promise.resolve().then(function(){var n=function(e){if(!e||1!==e.length)throw new Error({message:"shredded data is not in the correct format."});var n=e[0].data;return n&&1===n.length&&"single"===e[0].resourceType?n[0]:n}(t);return e.setResponsePayload(r,n)}).then(function(e){return e.headers.set("x-oracle-jscpt-cache-expiration-date",""),Promise.resolve(e)})}}}}),define("oracleRestJsonShredding",["./persistenceUtils","./impl/logger"],function(e,n){"use strict";return{getShredder:function(e,t){return function(r){n.log("Offline Persistence Toolkit oracleRestJsonShredding: Shredding Response");var o=r.clone(),s=o.headers.get("X-ORACLE-DMS-ECID");return o.text().then(function(r){var o=[],i=[],a="collection";if(null!=r&&r.length>0)try{var l=JSON.parse(r);null!=l.items?(o=l.items.map(function(e){return e[t]}),i=l.items):(o[0]=l[t],i[0]=l,a="single")}catch(e){n.log("Offline Persistence Toolkit oracleRestJsonShredding: Error during shredding: "+e)}return[{name:e,resourceIdentifier:s,keys:o,data:i,resourceType:a}]})}},getUnshredder:function(){return function(t,r){n.log("Offline Persistence Toolkit oracleRestJsonShredding: Unshredding Response");var o=function(e,n){if(!e||1!==e.length)throw new Error({message:"shredded data is not in the correct format."});var t=e[0].data;return t&&1===t.length&&"single"===e[0].resourceType?t[0]:{items:t,count:t.length}}(t);return e.setResponsePayload(r,o).then(function(e){return e.headers.set("x-oracle-jscpt-cache-expiration-date",""),e})}}}}),define("simpleBinaryDataShredding",["./persistenceUtils"],function(e){"use strict";return{getShredder:function(e){return function(n){var t=n.clone(),r=t.headers.get("Etag");return t.blob().then(function(t){var o=[],s=[];return o[0]=null==n.url||0==n.url.length?n.headers.get("x-oracle-jscpt-response-url"):n.url,s[0]=t,[{name:e,resourceIdentifier:r,keys:o,data:s,resourceType:"single"}]})}},getUnshredder:function(){return function(n,t){var r=function(e){if(!e||1!==e.length)throw new Error({message:"shredded data is not in the correct format."});var n=e[0].data;return n&&1===n.length&&"single"===e[0].resourceType?n[0]:n}(n);return e.setResponsePayload(t,r).then(function(e){return e.headers.set("x-oracle-jscpt-cache-expiration-date",""),Promise.resolve(e)})}}}}),define("queryHandlers",["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger"],function(e,n,t,r){"use strict";function o(r,o,s,i,a,c,f){return e.getCache().hasMatch(r,{ignoreSearch:!0}).then(function(h){return n.openStore(o).then(function(e){if(h)return e.find(s);var n=l(r);return n?e.findByKey(n):Promise.resolve([])}).then(function(n){return e.getCache().match(r,{ignoreSearch:!0}).then(function(s){if(s){var l=!1;return n&&(c&&c>0&&(l=c<n.length,n=n.slice(c,n.length)),f&&f>0&&(l=f<=n.length,n=n.slice(0,f))),i(s).then(function(e){var r=e[0].resourceType;return a([{name:o,data:n,resourceType:r}],s).then(function(e){return e.clone().text().then(function(n){if(!(null!=n&&n.length>0))return e;try{var r=JSON.parse(n);return null!=r.items&&(f&&(r.limit=parseInt(f,10)),c&&(r.offset=parseInt(c,10)),r.hasMore=l),t.setResponsePayload(e,r)}catch(e){}})})})}if(n&&Object.keys(n).length>0){var h=u(r);return h?t.requestToJSON(r).then(function(r){return r.url=h,t.requestFromJSON(r).then(function(t){return e.getCache().match(t,{ignoreSearch:!0}).then(function(e){if(e)return a([{name:o,data:[n],resourceType:"single"}],e)})})}):Promise.resolve()}return Promise.resolve()})})})}function s(e,n){var t={};if(e&&e.length>1){var r,o,s,a,l={};r="undefined"==typeof URLSearchParams?i(e[1]):new URLSearchParams(e[1]).entries();do{null!=(o=r.next()).value&&(s=o.value[0],a=o.value[1],n&&-1!=n.indexOf(s)||(l["value."+s]=a))}while(!o.done);Object.keys(l).length>0&&(t.selector=l)}return t}function i(e){var n=[];if(null!=e){"?"===e.charAt(0)&&(e=e.slice(1));var t,r,o,s=(e=e||"").split("&");n=s.map(function(e){return(o=e.indexOf("="))>-1?(t=e.slice(0,o),r=a(r=e.slice(o+1))):(t=e,r=""),[t=a(t),r]})}return{next:function(){var e=n.shift();return{done:void 0===e,value:e}}}}function a(e){return decodeURIComponent(e.replace(/\+/g," "))}function l(e){var n=e.url.split("/");return n.length>1?n[n.length-1]:null}function u(e){if(e.url.split("/").length>1){var n=l(e);return e.url.substring(0,e.url.length-n.length-1)}return null}return{getSimpleQueryHandler:function(e,n){return function(t,i){if("GET"==t.method||"HEAD"==t.method){r.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var a,l,u=s(t.url.split("?"),n);if(null!=i.jsonProcessor&&(a=i.jsonProcessor.shredder,l=i.jsonProcessor.unshredder),null!=a&&null!=l)return o(t,e,u,a,l)}return Promise.resolve()}},getOracleRestQueryHandler:function(e,n){return n=n||function(e){return function(e){var n={};if(e){var t,r,o=e.split(";"),s={};for(t=0;t<o.length;t++)if(r=o[t].split("=")[0]){var i=o[t].split("=")[1].replace(/^"|'(.*)'|"$/,"$1");s["value."+r]=i}Object.keys(s).length>0&&(n.selector=s)}return n}(e)},function(s,a){if("GET"==s.method||"HEAD"==s.method){r.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var l,u,c,f,h,d,g,p=s.url.split("?");u="undefined"==typeof URLSearchParams?i(p[1]):new URLSearchParams(p[1]).entries();do{null!=(c=u.next()).value&&(f=c.value[0],h=c.value[1],"q"==f?l=h:"limit"==f?d=h:"offset"==f&&(g=h))}while(!c.done);var P,v,m=n(l);if(null!=a.jsonProcessor&&(P=a.jsonProcessor.shredder,v=a.jsonProcessor.unshredder),null!=P&&null!=v)return o(s,e,m,P,v,g,d).then(function(e){return e?e.clone().text().then(function(n){if(null!=n&&n.length>0)try{var r=JSON.parse(n);return r.links?Promise.resolve(e):(r.links=[{rel:"self",href:s.url}],t.setResponsePayload(e,r).then(function(e){return Promise.resolve(e)}))}catch(e){}}):Promise.resolve()})}return Promise.resolve()}}}});