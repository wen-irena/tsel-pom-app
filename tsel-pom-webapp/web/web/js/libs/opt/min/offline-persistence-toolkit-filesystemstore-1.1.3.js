define("PersistenceStore",[],function(){"use strict";var e=function(e){this._name=e};return(e.prototype={}).getName=function(){return this._name},e.prototype.getVersion=function(){return this._version},e.prototype.Init=function(e){return e&&e.version?this._version=e.version:this._version="0",Promise.resolve()},e.prototype.upsert=function(e,t,r,n){throw TypeError("failed in abstract function")},e.prototype.upsertAll=function(e){throw TypeError("failed in abstract function")},e.prototype.find=function(e){throw TypeError("failed in abstract function")},e.prototype.findByKey=function(e){throw TypeError("failed in abstract function")},e.prototype.removeByKey=function(e){throw TypeError("failed in abstract function")},e.prototype.delete=function(e){throw TypeError("failed in abstract function")},e.prototype.keys=function(){throw TypeError("failed in abstract function")},e}),define("impl/storageUtils",["./logger"],function(e){"use strict";function t(e){var n,u=[];for(var f in e)if(e.hasOwnProperty(f)){var a=e[f];if(0===f.indexOf("$")){if(o(f)){if(!(a instanceof Array))throw new Error("not a valid expression: "+e);n={operator:f,array:[]};for(var c=0;c<a.length;c++){var l=t(a[c]);n.array.push(l)}}else if(i(f))throw new Error("not a valid expression: "+e)}else if(s(a))u.push({left:f,right:a,operator:"$eq"});else{var y={left:f};r(y,a),u.push(y)}}return u.length>1?n={operator:"$and",array:u}:1===u.length&&(n=u[0]),n}function r(e,t){var r=!1;for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];if(r||!i(n))throw new Error("parsing error "+t);e.operator=n,e.right=o,r=!0}}function n(e,t){var r=e.operator;if(o(r)){if(!e.left&&e.array instanceof Array){for(var s,u=e.array,c=0;c<u.length;c++){var l=n(u[c],t);if("$or"===r&&!0===l)return!0;if("$and"===r&&!1===l)return!1;s=l}return s}throw new Error("invalid expression tree!"+e)}if(i(r)){var y,p=a(e.left,t),h=e.right;if("$lt"===r)return(p=(y=f(p,h))[0])<(h=y[1]);if("$gt"===r)return(p=(y=f(p,h))[0])>(h=y[1]);if("$lte"===r)return(p=(y=f(p,h))[0])<=(h=y[1]);if("$gte"===r)return(p=(y=f(p,h))[0])>=(h=y[1]);if("$eq"===r)return p===h;if("$ne"===r)return p!==h;if("$regex"===r)return null!==p.match(h);if("$exists"===r)return h?null!==p&&void 0!==p:null===p||void 0===p;throw new Error("not a valid expression! "+e)}throw new Error("not a valid expression!"+e)}function o(e){return"$and"===e||"$or"===e}function i(e){return"$lt"===e||"$gt"===e||"$lte"===e||"$gte"===e||"$eq"===e||"$ne"===e||"$regex"===e||"$exists"===e}function s(e){return"object"!=typeof e}function u(e){return null!=e&&(e instanceof String||"string"==typeof e)}function f(e,t){return u(e)&&null==t?t="":u(t)&&null==e&&(e=""),[e,t]}function a(e,t){for(var r=e.split("."),n=t,o=0;o<r.length;o++)n=n[r[o]];return n}return{satisfy:function(r,o){return e.log("Offline Persistence Toolkit storageUtils: Processing selector: "+JSON.stringify(r)),!r||n(t(r),o)},getValue:a}}),define("impl/keyValuePersistenceStore",["../PersistenceStore","./storageUtils","./logger"],function(e,t,r){"use strict";var n=function(t){e.call(this,t)};return(n.prototype=new e).Init=function(e){return this._version=e&&e.version||"0",Promise.resolve()},n.prototype.getItem=function(e){throw TypeError("failed in abstract function")},n.prototype.removeByKey=function(e){throw TypeError("failed in abstract function")},n.prototype.keys=function(){throw TypeError("failed in abstract function")},n.prototype.findByKey=function(e){return r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: findByKey() with key: "+e),this.getItem(e).then(function(e){return e?Promise.resolve(e.value):Promise.resolve()})},n.prototype.find=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: find() with expression: "+JSON.stringify(e));var n=this,o=[],i=[];e=e||{};return this.keys().then(function(r){for(var s=[],u=0;u<r.length;u++){var f=r[u];f&&s.push(function(r){return n.getItem(r).then(function(n){n&&t.satisfy(e.selector,n)&&(n.key=r,i.push(n))})}(f))}return Promise.all(s).then(function(){for(var t=n._sort(i,e.sort),r=0;r<t.length;r++)o.push(n._constructReturnObject(e.fields,t[r]));return Promise.resolve(o)})})},n.prototype._sort=function(e,t){return e&&e.length&&t&&t.length?e.sort(this._sortFunction(t,this)):e},n.prototype._sortFunction=function(e,r){return function(r,n){for(var o=0;o<e.length;o++){var i,s=e[o],u=!0;if("string"==typeof s)i=s;else{if("object"!=typeof s)throw new Error("invalid sort criteria.");var f=Object.keys(s);if(!f||1!==f.length)throw new Error("invalid sort criteria");u="asc"===s[i=f[0]].toLowerCase()}var a=t.getValue(i,r),c=t.getValue(i,n);if(a!=c)return u?a<c?-1:1:a<c?1:-1}return 0}},n.prototype._constructReturnObject=function(e,t){var r;if(e){r={};for(var n=0;n<e.length;n++)for(var o=r,i=t,s=e[n].split("."),u=0;u<s.length;u++)i=i[s[u]],!o[s[u]]&&u<s.length-1&&(o[s[u]]={}),u===s.length-1?o[s[u]]=i:o=o[s[u]]}else r=t.value;return r},n.prototype._removeByKeyMapCallback=function(e){var t=this;return function(r){var n;return n=e?r[e]:r,t.removeByKey(n)}},n.prototype.delete=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: delete() with expression: "+JSON.stringify(e));var t=this;if(!e)return this.deleteAll();var n=e;return n.fields=["key"],t.find(n).then(function(e){if(e&&e.length){var r=e.map(t._removeByKeyMapCallback("key"),t);return Promise.all(r)}return Promise.resolve()})},n.prototype.deleteAll=function(){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: deleteAll()");var e,t=this,n=[];return this.keys().then(function(r){for(e=0;e<r.length;e++)n.push(t.removeByKey(r[e]));return Promise.all(n)})},n.prototype.upsert=function(e,t,n,o){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: upsert() for key: "+e);var i=this;return this.getItem(e).then(function(r){if(r&&o){var s=r.metadata.versionIdentifier;return s!==o?Promise.reject({status:409}):t.versionIdentifier!==s?i._insert(e,t,n):Promise.resolve()}return i._insert(e,t,n)})},n.prototype.upsertAll=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: upsertAll()");for(var t=[],n=0;n<e.length;n++){var o=e[n];t.push(this.upsert(o.key,o.metadata,o.value,o.expectedVersionIndentifier))}return Promise.all(t)},n}),define("impl/fileSystemPersistenceStore",["./keyValuePersistenceStore","../persistenceStoreManager","./logger"],function(e,t,r){"use strict";function n(e,t,r,n,i){return new Promise(function(s,u){e._directory.getFile(t,{create:!0,exclusive:!1},function(e){e.createWriter(function(e){e.onwriteend=function(){o(r,t,n).then(function(){s()})},e.onerror=function(e){u(e)},"JSON"==n.data_type&&(i=JSON.stringify(i)),e.write(i)})})})}function o(e,t,r){return i().then(function(n){return n.upsert(e,r,{filename:t,metadata:r})})}function i(){return t.openStore("fileIndex",{index:["key"]})}function s(e,t){return new Promise(function(r,n){e._directory.getFile(t,{create:!1,exclusive:!1},function(e){r(e)},function(e){e.code===FileError.NOT_FOUND_ERR||e.code===FileError.SYNTAX_ERR?r(null):n(e)})})}function u(e){return i().then(function(t){return t.findByKey(e)})}function f(e,t){return s(e,t).then(function(e){return!!e&&new Promise(function(t,r){e.remove(function(){t(!0)},function(e){t(!1)})})})}function a(e){var t=e.replace(/[<>\:"\/\\\|\?\*\~]/g,"").replace(/^\.+$/,"").replace(/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,"").replace(/[\x00-\x1f\x80-\x9f]/g,"");return t.length>255?t.slice(0,255):t}var c=function(t){e.call(this,t),this._directoryName=a(t),this._directory=null};return(c.prototype=new e).Init=function(t){var r=this;return e.prototype.Init.call(r,t).then(function(){return r._directoryName=a(r._name+r._version),new Promise(function(e,t){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){t.root.getDirectory(r._directoryName,{create:!0},function(t){r._directory=t,e()})},function(e){t(e)})})})},c.prototype._insert=function(e,t,r){var o=this;return this.removeByKey(e).then(function(){r instanceof Blob?t.data_type="Blob":t.data_type="JSON";var i=o._directory.createReader();return new Promise(function(s,u){i.readEntries(function(i){for(var u=function(e){return i.filter(function(t){return t.name==e}).length>0},f=Math.floor(1e8*Math.random())+".pds";u(f);)f=Math.floor(1e8*Math.random())+".pds";n(o,f,e,t,r).then(function(){s()})})})})},c.prototype.getItem=function(e){r.log("Offline Persistence Toolkit fileSystemPersistenceStore: getItem() with key: "+e);var t=this;return u(e).then(function(e){if(e){var r=e.filename,n=e.metadata;return s(t,r).then(function(e){if(e)return new Promise(function(t,r){e.file(function(e){var r=new FileReader;r.onloadend=function(e){var r=function(e,t){var r=new DataView(e.slice(t));return new Blob([r])}(this.result,0);if("JSON"==n.data_type){var o=new FileReader;o.onloadend=function(){t({metadata:n,value:JSON.parse(this.result)})},o.readAsText(r)}else t({metadata:n,value:r})},r.readAsArrayBuffer(e)},function(e){r(e)})})})}})},c.prototype.removeByKey=function(e){r.log("Offline Persistence Toolkit fileSystemPersistenceStore: removeByKey() with key: "+e);var t=this;return u(e).then(function(r){return r?function(e){return i().then(function(t){return t.removeByKey(e)})}(e).then(function(){return f(t,r.filename)}):Promise.resolve(!1)})},c.prototype.keys=function(){return r.log("Offline Persistence Toolkit fileSystemPersistenceStore: keys()"),i().then(function(e){return e.keys()})},c.prototype.deleteAll=function(){r.log("Offline Persistence Toolkit fileSystemPersistenceStore: deleteAll()");var e=this;return i().then(function(e){return e.delete()}).then(function(){var t=[],r=e._directory.createReader();return t.push(new Promise(function(n,o){r.readEntries(function(r){r.map(function(r){t.push(f(e,r.name))}),n()})})),Promise.all(t)})},c}),define("fileSystemPersistenceStoreFactory",["./impl/fileSystemPersistenceStore"],function(e){"use strict";return function(){function t(t,r){var n=new e(t);return n.Init(r).then(function(){return n})}return{createPersistenceStore:function(e,r){return t(e,r)}}}()}),define("persistenceStoreFactory",[],function(){"use strict";return{createPersistenceStore:function(e,t){}}});