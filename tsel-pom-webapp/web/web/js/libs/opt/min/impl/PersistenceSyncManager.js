define(["require","../persistenceUtils","../persistenceStoreManager","./defaultCacheHandler","./logger"],function(e,n,t,r,s){"use strict";function o(e,n,t){Object.defineProperty(this,"_eventListeners",{value:[],writable:!0}),Object.defineProperty(this,"_isOnline",{value:e}),Object.defineProperty(this,"_browserFetch",{value:n}),Object.defineProperty(this,"_cache",{value:t})}function i(e){var n=e;return g().then(function(e){return e.find(function(){var e={},n=[],t=[];t.push("metadata.created"),e.sort=t,n.push("metadata.created"),n.push("value"),e.fields=n;var r={},s={$exists:!0};return r["metadata.created"]=s,e.selector=r,e}())}).then(function(e){return l(e)}).then(function(e){return n._readingSyncLog=null,e})}function u(e){return"stop"===(e=e||{}).action}function c(e,n){return{requestId:e,request:n,undo:function(){return function(e){return p().then(function(n){return n.findByKey(e)}).then(function(e){return null!=e&&f(e,!0).then(function(){return!0})})}(e)},redo:function(){return function(e){return p().then(function(n){return n.findByKey(e)}).then(function(e){return null!=e&&f(e,!1).then(function(){return!0})})}(e)}}}function l(e){var t,r,s=[],o=function(e){return e&&0!=e.length?(t=e[0].metadata.created.toString(),r=e[0].value,n.requestFromJSON(r).then(function(n){return s.push(c(t,n)),e.shift(),o(e)})):Promise.resolve(s)};return o(e)}function f(e,n){var r,s,o,i,u,c=[];e instanceof Array||(e=[e]);var l=e.length,f=function(a){if(!(a<l))return Promise.resolve();if(o=e[a].storeName,s=e[a].operation,i=e[a].undoRedoData,"upsert"==s||"remove"==s&&n){for(c=[],u=i.length,r=0;r<u;r++)n?c.push({key:i[r].key,value:i[r].undo}):c.push({key:i[r].key,value:i[r].redo});return t.openStore(o).then(function(e){return 1==c.length&&null==c[0].value&&null!=c[0].key?e.removeByKey(c[0].key).then(function(){return f(++a)}):e.upsertAll(c).then(function(){return f(++a)})})}return"remove"==s?t.openStore(o).then(function(e){return e.removeByKey(i[0].key).then(function(){return f(++a)})}):void 0};return f(0)}function a(e,n,t,r){return function e(n,t){return t.length>0?t[0].listener(n).then(function(n){return null!=n?Promise.resolve(n):t.length>1?e(t.slice(1)):void 0}):Promise.resolve(null)}(t,e._eventListeners.filter(function(e,n){return function(t){return e.toLowerCase()==t.type&&(null!=n&&n.match(t.scope)||null==n||null==t.scope)}}(n,r)))}function h(e){return t.openStore(e,{index:["metadata.created"]})}function g(){return h("syncLog")}function p(){return h("redoUndoLog")}return o.prototype.addEventListener=function(e,n,t){s.log("Offline Persistence Toolkit PersistenceSyncManager: addEventListener() for type: "+e+" and scope: "+t),this._eventListeners.push({type:e.toLowerCase(),listener:n,scope:t})},o.prototype.removeEventListener=function(e,n,t){s.log("Offline Persistence Toolkit PersistenceSyncManager: removeEventListener() for type: "+e+" and scope: "+t),this._eventListeners=this._eventListeners.filter(function(r){return e.toLowerCase()!=r.type||n!=r.listener||t!=r.scope})},o.prototype.getSyncLog=function(){return s.log("Offline Persistence Toolkit PersistenceSyncManager: getSyncLog()"),this._readingSyncLog||(this._readingSyncLog=i(this)),this._readingSyncLog},o.prototype.insertRequest=function(e,t){s.log("Offline Persistence Toolkit PersistenceSyncManager: insertRequest() for Request with url: "+e.url);var o={};return g().then(function(t){return o.store=t,n.requestToJSON(e,{_noClone:!0})}).then(function(n){return o.requestData=n,o.metadata=r.constructMetadata(e),o.requestId=o.metadata.created.toString(),o.store.upsert(o.requestId,o.metadata,o.requestData)}).then(function(){if(null!=t){var e=t.undoRedoDataArray;return null!=e?p().then(function(n){var t=function(r){return r<e.length&&null!=e[r]?n.upsert(o.requestId,o.metadata,e[r]).then(function(){return t(++r)}):Promise.resolve()};return t(0)}):Promise.resolve()}return Promise.resolve()})},o.prototype.removeRequest=function(e){s.log("Offline Persistence Toolkit PersistenceSyncManager: removeRequest() for Request with requestId: "+e);var n=this,t={};return g().then(function(r){return t.store=r,function(e,n){return e.getSyncLog().then(function(e){var t,r=e.length;for(t=0;t<r;t++)if(e[t].requestId===n)return e[t].request})}(n,e)}).then(function(n){return t.request=n,t.store.removeByKey(e)}).then(function(){return p()}).then(function(n){return n.removeByKey(e)}).then(function(){return t.request})},o.prototype.updateRequest=function(e,t){return s.log("Offline Persistence Toolkit PersistenceSyncManager: updateRequest() for Request with requestId: "+e),Promise.all([g(),n.requestToJSON(t)]).then(function(n){var s=n[0],o=n[1],i=r.constructMetadata(t);return s.upsert(e,i,o)})},o.prototype.sync=function(e){s.log("Offline Persistence Toolkit PersistenceSyncManager: sync()"),this._options=e||{};var t=this;return this._syncing?Promise.reject("Cannot start sync while sync is in progress"):(this._syncing=!0,new Promise(function(e,r){t.getSyncLog().then(function(o){if(t._isOnline()){s.log("Offline Persistence Toolkit PersistenceSyncManager: Processing sync, is online");var i,c,l,f=function(o){0==o.length&&(s.log("Offline Persistence Toolkit PersistenceSyncManager: Sync finished, no requests in sync log"),e()),o.length>0&&(s.log("Offline Persistence Toolkit PersistenceSyncManager: Processing sync, # of request in sync log: "+o.length),i=o[0].requestId,c=o[0].request,l=c.clone(),s.log("Offline Persistence Toolkit PersistenceSyncManager: Dispatching beforeSyncRequest event"),a(t,"beforeSyncRequest",{requestId:i,request:l.clone()},c.url).then(function(h){if(u(h))return s.log("Offline Persistence Toolkit PersistenceSyncManager: Sync stopped by beforeSyncRequest event listener"),void e();"skip"!==(h=h||{}).action?("replay"===h.action&&(s.log("Offline Persistence Toolkit PersistenceSyncManager: Replay request from beforeSyncRequest event listener"),c=h.request),l=c.clone(),function(e,n){var t=e,r=t._options.preflightOptionsRequest,o=t._options.preflightOptionsRequestTimeout;if(null!=n.url&&"disabled"!=r&&null!=n.url.match(r)){if(s.log("Offline Persistence Toolkit PersistenceSyncManager: Checking URL based on preflightOptionsRequest"),t._pingedURLs){if(t._pingedURLs.indexOf(n.url)>=0)return Promise.resolve(!0)}else t._pingedURLs=[];return t._preflightOptionsRequestId=(new Date).getTime(),new Promise(function(e){return function(r,s){t._repliedOptionsRequest=!1;var i=new Request(n.url,{method:"OPTIONS"}),u=6e4;null!=o&&(u=o),setTimeout(function(){t._repliedOptionsRequest||t._preflightOptionsRequestId!=e||s(!1)},u),t._browserFetch(i).then(function(e){t._repliedOptionsRequest=!0,t._pingedURLs||(t._pingedURLs=[]),t._pingedURLs.push(n.url),r(!0)},function(e){t._repliedOptionsRequest=!0,r(!0)})}}(t._preflightOptionsRequestId))}return Promise.resolve(!0)}(t,c).then(function(){s.log("Offline Persistence Toolkit PersistenceSyncManager: Replaying request with url: "+c.url),t._browserFetch(c).then(function(h){h.status>=400?r({error:h.statusText,requestId:i,request:l.clone(),response:h.clone()}):n._cloneResponse(h,{url:c.url}).then(function(h){s.log("Offline Persistence Toolkit PersistenceSyncManager: Dispatching syncRequest event"),a(t,"syncRequest",{requestId:i,request:l.clone(),response:h.clone()},c.url).then(function(a){u(a)?e():(s.log("Offline Persistence Toolkit PersistenceSyncManager: Removing replayed request"),t.removeRequest(i).then(function(){o.shift(),"GET"==c.method||"HEAD"==c.method?n._cloneResponse(h,{url:c.url}).then(function(e){t._cache().put(c,e).then(function(){s.log("Offline Persistence Toolkit PersistenceSyncManager: Replayed request/response is cached."),f(o)})}):f(o)},function(e){r({error:e,requestId:i,request:l.clone()})}))})})},function(e){r({error:e,requestId:i,request:l.clone()})})},function(e){if(!1===e){r({error:"Preflight OPTIONS request timed out",requestId:i,request:l.clone(),response:new Response(null,{status:504,statusText:"Preflight OPTIONS request timed out"})})}else r({error:e,requestId:i,request:l.clone()})})):(s.log("Offline Persistence Toolkit PersistenceSyncManager: Removing skipped request"),t.removeRequest(i).then(function(){o.shift(),f(o)},function(e){r({error:e,requestId:i,request:l.clone()})}))}))};o=function(e){if(e&&e.length>0){var n,t,r=[];for(n=0;n<e.length;n++)"GET"!=(t=e[n].request).method&&"HEAD"!=t.method&&r.push(e[n]);for(n=0;n<e.length;n++)"GET"!=(t=e[n].request).method&&"HEAD"!=t.method||r.push(e[n]);return r}return e}(o),f(o)}else e()})}).then(function(e){return t._syncing=!1,t._pingedURLs=null,e},function(e){return t._syncing=!1,t._pingedURLs=null,Promise.reject(e)}))},o});