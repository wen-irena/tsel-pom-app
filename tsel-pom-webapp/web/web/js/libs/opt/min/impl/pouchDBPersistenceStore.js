define(["../PersistenceStore","../impl/storageUtils","pouchdb","./logger"],function(e,t,r,n){"use strict";var i=function(t){e.call(this,t)};(i.prototype=new e).Init=function(e){this._version=e&&e.version||"0";var t=this._name+this._version;if(this._db=new r(t),e&&e.index){var n=this,i=e.index,o={index:{fields:i,name:n._name+i.toString().replace(",","").replace(".","")}};return n._db.createIndex?n._db.createIndex(o).then(function(){return Promise.resolve()}):Promise.resolve()}return Promise.resolve()},i.prototype.upsert=function(e,t,r,i){n.log("Offline Persistence Toolkit pouchDBPersistenceStore: upsert() for key: "+e);var s=this,u=e.toString(),c=[];return this._prepareUpsert(r,c),s._db.get(u).then(function(e){return o(i,e)?e:Promise.reject({status:409})}).catch(function(e){return 404===e.status&&"missing"===e.message?Promise.resolve():Promise.reject(e)}).then(function(e){return s._put(u,t,r,i,c,e)}).then(function(){return Promise.resolve()})},i.prototype._put=function(e,t,r,n,i,s){var u={_id:e,metadata:t,value:r};s&&(u._rev=s._rev);var c=this;return c._db.put(u).then(function(e){return Promise.resolve(e)}).catch(function(t){return 409===t.status?c._db.get(e).then(function(e){return n?o(n,e)?Promise.resolve(e):Promise.reject({status:409}):Promise.resolve(e)}):Promise.reject(t)}).then(function(e){return c._addAttachments(e,i)}).then(function(){return Promise.resolve()})};var o=function(e,t){return!e||t.metadata.versionIdentifier===e};return i.prototype._addAttachments=function(e,t){if(t&&t.length){var r=t.map(function(t){var r;return r=t.value instanceof Blob?t.value:new Blob([t.value]),this._db.putAttachment(e.id,t.path,e.rev,r,"binary")},this);return Promise.all(r)}return Promise.resolve()},i.prototype.upsertAll=function(e){if(n.log("Offline Persistence Toolkit pouchDBPersistenceStore: upsertAll()"),e&&e.length){var t=e.map(function(e){return this.upsert(e.key,e.metadata,e.value,e.expectedVersionIdentifier)},this);return Promise.all(t)}return Promise.resolve()},i.prototype.find=function(e){n.log("Offline Persistence Toolkit pouchDBPersistenceStore: find() for expression: "+JSON.stringify(e));var r=this,i=r._prepareFind(e);return r._db.find?r._db.find(i).then(function(e){if(e&&e.docs&&e.docs.length){var t=e.docs.map(r._findResultCallback(i.fields),r);return Promise.all(t)}return Promise.resolve([])}).catch(function(e){return 404===e.status&&"missing"===e.message?Promise.resolve([]):Promise.reject(e)}):r._db.allDocs({include_docs:!0}).then(function(n){if(n&&n.rows&&n.rows.length){var o=n.rows.filter(function(r){return!!t.satisfy(e.selector,r.doc)}).map(function(e){return r._findResultCallback(i.fields).bind(r)(e.doc)});return Promise.all(o)}return Promise.resolve([])})},i.prototype._findResultCallback=function(e){return function(t){return this._fixValue(t).then(function(t){return e?t:t.value})}},i.prototype._fixValue=function(e){var t=e._id||e.id||e.key;t&&(e.key=t);var r=e._attachments;if(r){var n=Object.keys(r)[0];return this._db.getAttachment(t,n).then(function(t){for(var r=n.split("."),i=e.value,o=0;o<r.length-1;o++)i=i[r[o]];return i[r[r.length-1]]=t,e})}return Promise.resolve(e)},i.prototype.findByKey=function(e){n.log("Offline Persistence Toolkit pouchDBPersistenceStore: findByKey() for key: "+e);var t=e.toString();return this._db.get(t).then(function(e){return e.value}).catch(function(e){return 404===e.status&&"missing"===e.message?Promise.resolve():Promise.reject(e)})},i.prototype.removeByKey=function(e){n.log("Offline Persistence Toolkit pouchDBPersistenceStore: removeByKey() for key: "+e);var t=this,r=e.toString();return t._db.get(r).then(function(e){return t._db.remove(e)}).then(function(){return!0}).catch(function(e){return 404===e.status&&"missing"===e.message?Promise.resolve(!1):Promise.reject(e)})},i.prototype.delete=function(e){n.log("Offline Persistence Toolkit pouchDBPersistenceStore: delete() for expression: "+JSON.stringify(e));var t=this;if(e){var r=e;return r.fields=["_id","_rev"],t.find(r).then(function(e){if(e&&e.length){var r=e.map(function(e){return this._db.remove(e._id,e._rev)},t);return Promise.all(r)}return Promise.resolve()}).then(function(){return Promise.resolve()})}return t._db.allDocs({include_docs:!0}).then(function(e){if(e&&e.rows&&e.rows.length){var r=e.rows.map(function(e){this._db.remove(e.doc)},t);return Promise.all(r)}return Promise.resolve()}).then(function(){return Promise.resolve()})},i.prototype.keys=function(){return n.log("Offline Persistence Toolkit pouchDBPersistenceStore: keys()"),this._db.allDocs().then(function(e){var t=e.rows,r=[];return t&&t.length&&(r=t.map(function(e){return e.id})),r})},i.prototype._prepareFind=function(e){var t=e||{};void 0!==t.sort&&delete t.sort,t.selector||(t.selector={_id:{$gt:null}});var r=t.fields;if(r&&r.length){var n=r.map(function(e){return"key"===e?"_id":e});t.fields=n}return t},i.prototype._prepareUpsert=function(e,t){this._inspectValue("",e,t)},i.prototype._inspectValue=function(e,t,r){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];if(i&&"object"==typeof i)if(i instanceof Blob||i instanceof ArrayBuffer){var o=e;o.length>0&&(o+=".");var s={path:o+n,value:i};r.push(s),t.key=null}else if(void 0===i.length){var u=e;e.length>0&&(e+="."),e+=n,this._inspectValue(e,i,r),e=u}}},i});