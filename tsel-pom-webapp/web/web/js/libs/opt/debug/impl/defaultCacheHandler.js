define(["../persistenceUtils","../persistenceStoreManager","./logger"],function(e,r,t){"use strict";function n(){Object.defineProperty(this,"_endpointToOptionsMap",{value:{},writable:!0})}function o(e){for(var r=e.name,t=e.resourceIdentifier,n=e.keys,o=[],s=(new Date).toUTCString(),a=0;a<n.length;a++){var i={key:n[a],metadata:{lastUpdated:s,resourceIdentifier:t},value:e.data[a]};o.push(i)}var u={};return u[r]=o,u}n.prototype.constructRequestResponseCacheData=function(r,n){var o=this,s={};return t.log("Offline Persistence Toolkit DefaultCacheHandler: constructRequestResponseCacheData()"),e.requestToJSON(r).then(function(t){s.requestData=t;var a=o._excludeBody(r);return e.responseToJSON(n,{excludeBody:a})}).then(function(e){return s.responseData=e,{key:o._constructCacheKey(r,n),metadata:o.constructMetadata(r),value:s}})},n.prototype.constructShreddedData=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: constructShreddedData()");var n=this._getShredder(e);return n?n(r).then(function(e){var r=e.map(o);return Promise.resolve(r)}):Promise.resolve()},n.prototype.shredResponse=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: shredResponse()");var n=this._getShredder(e);return n?n(r):Promise.resolve()},n.prototype.cacheShreddedData=function(e){return t.log("Offline Persistence Toolkit DefaultCacheHandler: cacheShreddedData()"),function(e){var n=e.map(function(e){var n=Object.keys(e)[0],o=e[n];return o&&o.length?function(e,n){return t.log("Offline Persistence Toolkit DefaultCacheHandler: Updating store with shredded data"),r.openStore(e).then(function(e){return e.upsertAll(n)})}(n,o):Promise.resolve()});return Promise.all(n)}(e.map(o))},n.prototype._constructCacheKey=function(e,r){var t=e.url+e.method;if(r){var n=r.headers;if(n)if(i=n.get("vary"))if("*"===i)t+=(new Date).getTime();else for(var o=e.headers,s=i.split(","),a=0;a<s.length;a++){var i,u=s[a];t+=u+"="+(i=o?o.get(u):"undefined")}}return t},n.prototype.constructMetadata=function(e){var r=(new Date).getTime();return{url:e.url,method:e.method,created:r,lastupdated:r}},n.prototype.constructResponse=function(r){return t.log("Offline Persistence Toolkit DefaultCacheHandler: constructResponse()"),e.responseFromJSON(r).then(function(r){return e.isCachedResponse(r)||r.headers.set("x-oracle-jscpt-cache-expiration-date",""),Promise.resolve(r)})},n.prototype.constructSearchCriteria=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: constructSearchCriteria()");var n=!1;r&&void 0!==r.ignoreSearch&&(n=r.ignoreSearch);var o,a,i=!1;r&&void 0!==r.ignoreMethod&&(i=r.ignoreMethod);var u=e.url.indexOf("?");return a=u>=0?e.url.substring(0,u):e.url,o=n?{"metadata.url":{$regex:"^"+s(a)+"(\\?|$)"}}:{"metadata.url":e.url},i||(o["metadata.method"]=e.method),{selector:o,sort:[{"metadata.created":"asc"}]}},n.prototype.registerEndpointOptions=function(e,r){if(!e)throw new Error({message:"a valid endpointKey must be provided."});if(this._endpointToOptionsMap[e])throw new Error({message:"endpointKey can only be registered once."});this._endpointToOptionsMap[e]=r},n.prototype.unregisterEndpointOptions=function(e){if(!e)throw new Error({message:"a valid endpointKey must be provided."});delete this._endpointToOptionsMap[e]},n.prototype._excludeBody=function(e){return null!==this._getShredder(e)},n.prototype._getShredder=function(e){var r=this._getJsonProcessor(e);return r?r.shredder:null},n.prototype._getUnshredder=function(e){var r=this._getJsonProcessor(e);return r?r.unshredder:null},n.prototype._getJsonProcessor=function(e){for(var r=Object.keys(this._endpointToOptionsMap),t=0;t<r.length;t++){var n=r[t];if(e.url===JSON.parse(n).url){var o=this._endpointToOptionsMap[n];return o&&o.jsonProcessor&&o.jsonProcessor.shredder&&o.jsonProcessor.unshredder?o.jsonProcessor:null}}return null},n.prototype.fillResponseBodyWithShreddedData=function(e,n,o){t.log("Offline Persistence Toolkit DefaultCacheHandler: fillResponseBodyWithShreddedData()"),null!=e.url&&e.url.length>0&&null==o.headers.get("x-oracle-jscpt-response-url")&&o.headers.set("x-oracle-jscpt-response-url",e.url);var s=this._getUnshredder(e),a=this._getShredder(e);if(!(s&&a&&o&&n&&n.length))return Promise.resolve(o);var i=n.map(function(e){return n=(t=e).name,r.openStore(n).then(function(e){if(t.keys&&t.keys.length){if(1===t.keys.length)return e.findByKey(t.keys[0]);var r=t.keys.map(function(e){return{key:e}}),n={selector:{$or:r}};return e.find(n)}return Promise.resolve([])}).then(function(e){return Array.isArray(e)||(e=[e]),t.data=e,Promise.resolve(t)});var t,n});return Promise.all(i).then(function(e){return s(e,o)})};var s=function(e){return String(e).replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};return new n});