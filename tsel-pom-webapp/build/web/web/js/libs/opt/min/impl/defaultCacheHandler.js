define(["../persistenceUtils","../persistenceStoreManager","./logger"],function(e,r,t){"use strict";function n(){Object.defineProperty(this,"_endpointToOptionsMap",{value:{},writable:!0})}function o(e,n){return t.log("Offline Persistence Toolkit DefaultCacheHandler: Updating store with shredded data"),r.openStore(e).then(function(e){return e.upsertAll(n)})}function s(e){for(var r=e.name,t=e.resourceIdentifier,n=e.keys,o=[],s=(new Date).toUTCString(),a=0;a<n.length;a++){var i={key:n[a],metadata:{lastUpdated:s,resourceIdentifier:t},value:e.data[a]};o.push(i)}var u={};return u[r]=o,u}function a(e){var t=e.name;return r.openStore(t).then(function(r){if(e.keys&&e.keys.length){if(1===e.keys.length)return r.findByKey(e.keys[0]);var t={selector:{$or:e.keys.map(function(e){return{key:e}})}};return r.find(t)}return Promise.resolve([])}).then(function(r){return Array.isArray(r)||(r=[r]),e.data=r,Promise.resolve(e)})}n.prototype.constructRequestResponseCacheData=function(r,n){var o=this,s={};return t.log("Offline Persistence Toolkit DefaultCacheHandler: constructRequestResponseCacheData()"),e.requestToJSON(r).then(function(t){s.requestData=t;var a=o._excludeBody(r);return e.responseToJSON(n,{excludeBody:a})}).then(function(e){return s.responseData=e,{key:o._constructCacheKey(r,n),metadata:o.constructMetadata(r),value:s}})},n.prototype.constructShreddedData=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: constructShreddedData()");var n=this._getShredder(e);return n?n(r).then(function(e){var r=e.map(s);return Promise.resolve(r)}):Promise.resolve()},n.prototype.shredResponse=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: shredResponse()");var n=this._getShredder(e);return n?n(r):Promise.resolve()},n.prototype.cacheShreddedData=function(e){return t.log("Offline Persistence Toolkit DefaultCacheHandler: cacheShreddedData()"),function(e){var r=e.map(function(e){var r=Object.keys(e)[0],t=e[r];return t&&t.length?o(r,t):Promise.resolve()});return Promise.all(r)}(e.map(s))},n.prototype._constructCacheKey=function(e,r){var t=e.url+e.method;if(r){var n=r.headers;if(n)if(i=n.get("vary"))if("*"===i)t+=(new Date).getTime();else for(var o=e.headers,s=i.split(","),a=0;a<s.length;a++){var i,u=s[a];t+=u+"="+(i=o?o.get(u):"undefined")}}return t},n.prototype.constructMetadata=function(e){var r=(new Date).getTime();return{url:e.url,method:e.method,created:r,lastupdated:r}},n.prototype.constructResponse=function(r){return t.log("Offline Persistence Toolkit DefaultCacheHandler: constructResponse()"),e.responseFromJSON(r).then(function(r){return e.isCachedResponse(r)||r.headers.set("x-oracle-jscpt-cache-expiration-date",""),Promise.resolve(r)})},n.prototype.constructSearchCriteria=function(e,r){t.log("Offline Persistence Toolkit DefaultCacheHandler: constructSearchCriteria()");var n=!1;r&&void 0!==r.ignoreSearch&&(n=r.ignoreSearch);var o=!1;r&&void 0!==r.ignoreMethod&&(o=r.ignoreMethod);var s,a,u=e.url.indexOf("?");return a=u>=0?e.url.substring(0,u):e.url,s=n?{"metadata.url":{$regex:"^"+i(a)+"(\\?|$)"}}:{"metadata.url":e.url},o||(s["metadata.method"]=e.method),{selector:s,sort:[{"metadata.created":"asc"}]}},n.prototype.registerEndpointOptions=function(e,r){if(!e)throw new Error({message:"a valid endpointKey must be provided."});if(this._endpointToOptionsMap[e])throw new Error({message:"endpointKey can only be registered once."});this._endpointToOptionsMap[e]=r},n.prototype.unregisterEndpointOptions=function(e){if(!e)throw new Error({message:"a valid endpointKey must be provided."});delete this._endpointToOptionsMap[e]},n.prototype._excludeBody=function(e){return null!==this._getShredder(e)},n.prototype._getShredder=function(e){var r=this._getJsonProcessor(e);return r?r.shredder:null},n.prototype._getUnshredder=function(e){var r=this._getJsonProcessor(e);return r?r.unshredder:null},n.prototype._getJsonProcessor=function(e){for(var r=Object.keys(this._endpointToOptionsMap),t=0;t<r.length;t++){var n=r[t];if(e.url===JSON.parse(n).url){var o=this._endpointToOptionsMap[n];return o&&o.jsonProcessor&&o.jsonProcessor.shredder&&o.jsonProcessor.unshredder?o.jsonProcessor:null}}return null},n.prototype.fillResponseBodyWithShreddedData=function(e,r,n){t.log("Offline Persistence Toolkit DefaultCacheHandler: fillResponseBodyWithShreddedData()"),null!=e.url&&e.url.length>0&&null==n.headers.get("x-oracle-jscpt-response-url")&&n.headers.set("x-oracle-jscpt-response-url",e.url);var o=this._getUnshredder(e),s=this._getShredder(e);if(!(o&&s&&n&&r&&r.length))return Promise.resolve(n);var i=r.map(function(e){return a(e)});return Promise.all(i).then(function(e){return o(e,n)})};var i=function(e){return String(e).replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};return new n});