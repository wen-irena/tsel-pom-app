define(["./keyValuePersistenceStore","../persistenceStoreManager","./logger"],function(e,n,t){"use strict";function r(e,n,t,r,o){return new Promise(function(u,c){e._directory.getFile(n,{create:!0,exclusive:!1},function(e){e.createWriter(function(e){e.onwriteend=function(){i(t,n,r).then(function(){u()})},e.onerror=function(e){c(e)},"JSON"==r.data_type&&(o=JSON.stringify(o)),e.write(o)})})})}function i(e,n,t){return o().then(function(r){return r.upsert(e,t,{filename:n,metadata:t})})}function o(){return n.openStore("fileIndex",{index:["key"]})}function u(e,n){return new Promise(function(t,r){e._directory.getFile(n,{create:!1,exclusive:!1},function(e){t(e)},function(e){e.code===FileError.NOT_FOUND_ERR||e.code===FileError.SYNTAX_ERR?t(null):r(e)})})}function c(e){return o().then(function(n){return n.findByKey(e)})}function f(e,n){return u(e,n).then(function(e){return!!e&&new Promise(function(n,t){e.remove(function(){n(!0)},function(e){n(!1)})})})}function a(e){var n=e.replace(/[<>\:"\/\\\|\?\*\~]/g,"").replace(/^\.+$/,"").replace(/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,"").replace(/[\x00-\x1f\x80-\x9f]/g,"");return n.length>255?n.slice(0,255):n}var l=function(n){e.call(this,n),this._directoryName=a(n),this._directory=null};return(l.prototype=new e).Init=function(n){var t=this;return e.prototype.Init.call(t,n).then(function(){return t._directoryName=a(t._name+t._version),new Promise(function(e,n){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(n){n.root.getDirectory(t._directoryName,{create:!0},function(n){t._directory=n,e()})},function(e){n(e)})})})},l.prototype._insert=function(e,n,t){var i=this;return this.removeByKey(e).then(function(){t instanceof Blob?n.data_type="Blob":n.data_type="JSON";var o=i._directory.createReader();return new Promise(function(u,c){o.readEntries(function(o){for(var c=Math.floor(1e8*Math.random())+".pds";function(e){return o.filter(function(n){return n.name==e}).length>0}(c);)c=Math.floor(1e8*Math.random())+".pds";r(i,c,e,n,t).then(function(){u()})})})})},l.prototype.getItem=function(e){t.log("Offline Persistence Toolkit fileSystemPersistenceStore: getItem() with key: "+e);var n=this;return c(e).then(function(e){if(e){var t=e.filename,r=e.metadata;return u(n,t).then(function(e){if(e)return new Promise(function(n,t){e.file(function(e){var t=new FileReader;t.onloadend=function(e){var t=function(e,n){var t=new DataView(e.slice(n));return new Blob([t])}(this.result,0);if("JSON"==r.data_type){var i=new FileReader;i.onloadend=function(){n({metadata:r,value:JSON.parse(this.result)})},i.readAsText(t)}else n({metadata:r,value:t})},t.readAsArrayBuffer(e)},function(e){t(e)})})})}})},l.prototype.removeByKey=function(e){t.log("Offline Persistence Toolkit fileSystemPersistenceStore: removeByKey() with key: "+e);var n=this;return c(e).then(function(t){return t?function(e){return o().then(function(n){return n.removeByKey(e)})}(e).then(function(){return f(n,t.filename)}):Promise.resolve(!1)})},l.prototype.keys=function(){return t.log("Offline Persistence Toolkit fileSystemPersistenceStore: keys()"),o().then(function(e){return e.keys()})},l.prototype.deleteAll=function(){t.log("Offline Persistence Toolkit fileSystemPersistenceStore: deleteAll()");var e=this;return o().then(function(e){return e.delete()}).then(function(){var n=[],t=e._directory.createReader();return n.push(new Promise(function(r,i){t.readEntries(function(t){t.map(function(t){n.push(f(e,t.name))}),r()})})),Promise.all(n)})},l});