define(["./logger"],function(r){"use strict";function e(r){var a,f=[];for(var u in r)if(r.hasOwnProperty(u)){var l=r[u];if(0===u.indexOf("$")){if(t(u)){if(!(l instanceof Array))throw new Error("not a valid expression: "+r);a={operator:u,array:[]};for(var s=0;s<l.length;s++){var v=e(l[s]);a.array.push(v)}}else if(i(u))throw new Error("not a valid expression: "+r)}else if(o(l))f.push({left:u,right:l,operator:"$eq"});else{var g={left:u};n(g,l),f.push(g)}}return f.length>1?a={operator:"$and",array:f}:1===f.length&&(a=f[0]),a}function n(r,e){var n=!1;for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];if(n||!i(t))throw new Error("parsing error "+e);r.operator=t,r.right=o,n=!0}}function t(r){return"$and"===r||"$or"===r}function i(r){return"$lt"===r||"$gt"===r||"$lte"===r||"$gte"===r||"$eq"===r||"$ne"===r||"$regex"===r||"$exists"===r}function o(r){return"object"!=typeof r}function a(r){return null!=r&&(r instanceof String||"string"==typeof r)}function f(r,e){return a(r)&&null==e?e="":a(e)&&null==r&&(r=""),[r,e]}function u(r,e){for(var n=r.split("."),t=e,i=0;i<n.length;i++)t=t[n[i]];return t}return{satisfy:function(n,o){return r.log("Offline Persistence Toolkit storageUtils: Processing selector: "+JSON.stringify(n)),!n||function r(e,n){var o=e.operator;if(t(o)){if(!e.left&&e.array instanceof Array){for(var a,l=e.array,s=0;s<l.length;s++){var v=r(l[s],n);if("$or"===o&&!0===v)return!0;if("$and"===o&&!1===v)return!1;a=v}return a}throw new Error("invalid expression tree!"+e)}if(i(o)){var g=u(e.left,n),$=e.right;if("$lt"===o){var c=f(g,$);return g=c[0],$=c[1],g<$}if("$gt"===o){var c=f(g,$);return g=c[0],$=c[1],g>$}if("$lte"===o){var c=f(g,$);return g=c[0],$=c[1],g<=$}if("$gte"===o){var c=f(g,$);return g=c[0],$=c[1],g>=$}if("$eq"===o)return g===$;if("$ne"===o)return g!==$;if("$regex"===o)return null!==g.match($);if("$exists"===o)return $?null!==g&&void 0!==g:null===g||void 0===g;throw new Error("not a valid expression! "+e)}throw new Error("not a valid expression!"+e)}(e(n),o)},getValue:u}});