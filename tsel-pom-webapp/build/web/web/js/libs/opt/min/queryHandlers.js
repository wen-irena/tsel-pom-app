define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger"],function(e,r,n,t){"use strict";function l(t,l,u,s,o,c,f){return e.getCache().hasMatch(t,{ignoreSearch:!0}).then(function(h){return r.openStore(l).then(function(e){if(h)return e.find(u);var r=i(t);return r?e.findByKey(r):Promise.resolve([])}).then(function(r){return e.getCache().match(t,{ignoreSearch:!0}).then(function(u){if(u){var i=!1;return r&&(c&&c>0&&(i=c<r.length,r=r.slice(c,r.length)),f&&f>0&&(i=f<=r.length,r=r.slice(0,f))),s(u).then(function(e){var t=e[0].resourceType;return o([{name:l,data:r,resourceType:t}],u).then(function(e){return e.clone().text().then(function(r){if(!(null!=r&&r.length>0))return e;try{var t=JSON.parse(r);return null!=t.items&&(f&&(t.limit=parseInt(f,10)),c&&(t.offset=parseInt(c,10)),t.hasMore=i),n.setResponsePayload(e,t)}catch(e){}})})})}if(r&&Object.keys(r).length>0){var h=a(t);return h?n.requestToJSON(t).then(function(t){return t.url=h,n.requestFromJSON(t).then(function(n){return e.getCache().match(n,{ignoreSearch:!0}).then(function(e){if(e)return o([{name:l,data:[r],resourceType:"single"}],e)})})}):Promise.resolve()}return Promise.resolve()})})})}function u(e,r){var n={};if(e&&e.length>1){var t,l,u,o,i={};t="undefined"==typeof URLSearchParams?s(e[1]):new URLSearchParams(e[1]).entries();do{null!=(l=t.next()).value&&(u=l.value[0],o=l.value[1],r&&-1!=r.indexOf(u)||(i["value."+u]=o))}while(!l.done);Object.keys(i).length>0&&(n.selector=i)}return n}function s(e){var r=[];if(null!=e){"?"===e.charAt(0)&&(e=e.slice(1));var n,t,l,u=(e=e||"").split("&");r=u.map(function(e){return(l=e.indexOf("="))>-1?(n=e.slice(0,l),t=o(t=e.slice(l+1))):(n=e,t=""),[n=o(n),t]})}return{next:function(){var e=r.shift();return{done:void 0===e,value:e}}}}function o(e){return decodeURIComponent(e.replace(/\+/g," "))}function i(e){var r=e.url.split("/");return r.length>1?r[r.length-1]:null}function a(e){if(e.url.split("/").length>1){var r=i(e);return e.url.substring(0,e.url.length-r.length-1)}return null}return{getSimpleQueryHandler:function(e,r){return function(n,s){if("GET"==n.method||"HEAD"==n.method){t.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var o,i,a=u(n.url.split("?"),r);if(null!=s.jsonProcessor&&(o=s.jsonProcessor.shredder,i=s.jsonProcessor.unshredder),null!=o&&null!=i)return l(n,e,a,o,i)}return Promise.resolve()}},getOracleRestQueryHandler:function(e,r){return r=r||function(e){return function(e){var r={};if(e){var n,t,l=e.split(";"),u={};for(n=0;n<l.length;n++)if(t=l[n].split("=")[0]){var s=l[n].split("=")[1].replace(/^"|'(.*)'|"$/,"$1");u["value."+t]=s}Object.keys(u).length>0&&(r.selector=u)}return r}(e)},function(u,o){if("GET"==u.method||"HEAD"==u.method){t.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var i,a,c,f,h,d,v,g=u.url.split("?");a="undefined"==typeof URLSearchParams?s(g[1]):new URLSearchParams(g[1]).entries();do{null!=(c=a.next()).value&&(f=c.value[0],h=c.value[1],"q"==f?i=h:"limit"==f?d=h:"offset"==f&&(v=h))}while(!c.done);var p,m,P=r(i);if(null!=o.jsonProcessor&&(p=o.jsonProcessor.shredder,m=o.jsonProcessor.unshredder),null!=p&&null!=m)return l(u,e,P,p,m,v,d).then(function(e){return e?e.clone().text().then(function(r){if(null!=r&&r.length>0)try{var t=JSON.parse(r);return t.links?Promise.resolve(e):(t.links=[{rel:"self",href:u.url}],n.setResponsePayload(e,t).then(function(e){return Promise.resolve(e)}))}catch(e){}}):Promise.resolve()})}return Promise.resolve()}}}});