define(["./impl/logger"],function(e){"use strict";function n(e){var n=e.get("Content-Type");return!(!n||-1===n.indexOf("text/")&&-1===n.indexOf("application/json"))}function r(n,r){e.log("Offline Persistence Toolkit persistenceUtils: requestToJSON()"),r&&r._noClone||(n=n.clone());var s={};return t(n,s,["body","headers","signal"]),s.headers=o(n.headers),a(n,s)}function t(e,n,r){for(var t in e)"function"!=typeof e[t]&&0!==t.indexOf("_")&&-1===r.indexOf(t)&&(n[t]=e[t])}function o(n){var r={};if(n.entries){var t,o,a,s=n.entries();do{(t=s.next()).value&&(o=t.value[0],a=t.value[1],r[o]=a)}while(!t.done)}else n.forEach&&n.forEach(function(e,n){r[n]=e});return function(n){var r=n.date;r||(e.log("Offline Persistence Toolkit persistenceUtils: Setting HTTP date header since it's null or not exposed"),r=(new Date).toUTCString(),n.date=r)}(r),r}function a(r,t){return t.body={},r instanceof Request&&(o=r.headers,(a=o.get("Content-Type"))&&-1!==a.indexOf("multipart/"))?function(n,r){if(e.log("Offline Persistence Toolkit persistenceUtils: Copying multipart payload"),"function"==typeof n.formData)return n.formData().then(function(e){var n,t,o,a,s={},i=e.entries();do{n=i.next(),(t=n.value)&&(o=t[0],a=t[1],s[o]=a)}while(!n.done);return r.body.formData=s,r});var t=n.headers.get("Content-Type");return n.text().then(function(e){for(var n=u(e,t),o={},a=0;a<n.length;a++)o[n[a].headers.name]=n[a].data;return r.body.formData=o,r})}(r,t):r instanceof Request||n(r.headers)?r.text().then(function(e){return t.body.text=e,t}):r instanceof Request||"function"!=typeof r.arrayBuffer?Promise.reject(new Error({message:"payload body type is not supported"})):r.arrayBuffer().then(function(e){return e.byteLength>0&&(t.body.arrayBuffer=e),t});var o,a}function s(n,r){e.log("Offline Persistence Toolkit persistenceUtils: responseToJSON()"),r&&r._noClone||(n=n.clone());var s={};return t(n,s,["body","headers"]),s.headers=o(n.headers),r&&r.excludeBody?Promise.resolve(s):a(n,s)}function i(n){e.log("Offline Persistence Toolkit persistenceUtils: requestFromJSON()");var r={};t(n,r,["headers","body","signal"]);var o=function(e,n){var r=!1,t=e.body;if(t.text&&t.text.length>0)n.body=t.text;else if(t.arrayBuffer)n.body=t.arrayBuffer;else if(t.formData){r=!0;var o=new FormData,a=t.formData;Object.keys(a).forEach(function(e){o.append(e,a[e])}),n.body=o}return r}(n,r);return r.headers=l(n,o),function(e,n){return Promise.resolve(new Request(e.url,n))}(n,r)}function l(e,n){var r=new Headers;return Object.keys(e.headers).forEach(function(t){("content-type"!==t||!n&&"content-type"===t)&&r.append(t,e.headers[t])}),r}function f(n){e.log("Offline Persistence Toolkit persistenceUtils: responseFromJSON()");var r={};return t(n,r,["headers","body"]),r.headers=l(n,!1),function(e,n){var r,t=e.body;t&&t.text?r=new Response(t.text,n):t&&t.arrayBuffer?(n.responseType="blob",r=new Response(t.arrayBuffer,n)):t&&t.blob?(n.responseType="blob",r=new Response(t.blob,n)):r=new Response(null,n);return Promise.resolve(r)}(n,r)}function u(n,r){e.log("Offline Persistence Toolkit persistenceUtils: parseMultipartFormData()");var t=r.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!t)throw new Error("not a valid multipart form data value.");var o,a=function(e){for(var n={},r={},t=e.split("\r\n"),o=0;o<t.length;o++){var a=t[o];if(0!==a.length){var s=a.split(";");if(1===s.length&&0===s[0].indexOf("Content-Type"))n.contentType=s[0].split(":")[1].trim();else for(var i=0;i<s.length;i++)if(-1!==s[i].indexOf("=")){var l=s[i].split("=");r[l[0].trim()]=l[1].substring(1,l[1].length-1)}}}return n.headers=r,n},s=function(e,n){var r=e.split("\r\n");return n&&n.indexOf("image")>=0?i(r[0],n):r[0]},i=function(e,n){var r=null;try{r=atob(e)}catch(e){return null}for(var t=new ArrayBuffer(r.length),o=new Uint8Array(t),a=0;a<r.length;a++)o[a]=r.charCodeAt(a);return new Blob([t],{type:n})},l=t[1]||t[2];if("string"==typeof n)o=n;else{var f=new Uint8Array(n);o=String.fromCharCode.apply(null,f)}for(var u=o.split(new RegExp(l)),c=[],d=1;d<u.length-1;d++){var p={},h=u[d].split("\r\n\r\n"),y=h[0],g=h[1],v=a(y);p.headers=v.headers,p.data=s(g,v.contentType),c.push(p)}return c}return{requestToJSON:r,requestFromJSON:i,responseToJSON:s,responseFromJSON:f,setResponsePayload:function(n,r){return e.log("Offline Persistence Toolkit persistenceUtils: setResponsePayload()"),s(n).then(function(e){var n=e.body;if(n.arrayBuffer){if(!(r instanceof ArrayBuffer))throw new Error({message:"unexpected payload"});n.arrayBuffer=r}else r instanceof Blob?n.blob=r:n.text=JSON.stringify(r);return f(e)})},parseMultipartFormData:u,isCachedResponse:function(e){return e.headers.has("x-oracle-jscpt-cache-expiration-date")},isGeneratedEtagResponse:function(e){return e.headers.has("x-oracle-jscpt-etag-generated")},_isTextPayload:n,buildEndpointKey:function(n){e.log("Offline Persistence Toolkit persistenceUtils: buildEndpointKey() for Request with url: "+n.url);var r={url:n.url,id:Math.random().toString(36).replace(/[^a-z]+/g,"")};return JSON.stringify(r)},_cloneRequest:function(e){return r(e,{_noClone:!0}).then(function(e){return i(e).then(function(e){return e})})},_cloneResponse:function(e,n){return n=n||{},s(e,{_noClone:!0}).then(function(e){return f(e).then(function(e){return null!=n.url&&n.url.length>0&&null==e.headers.get("x-oracle-jscpt-response-url")&&e.headers.set("x-oracle-jscpt-response-url",n.url),e})})}}});