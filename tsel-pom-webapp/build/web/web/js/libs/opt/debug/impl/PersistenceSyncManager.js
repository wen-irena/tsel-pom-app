define(["require","../persistenceUtils","../persistenceStoreManager","./defaultCacheHandler","./logger"],function(require,e,n,t,r){"use strict";function s(e,n,t){Object.defineProperty(this,"_eventListeners",{value:[],writable:!0}),Object.defineProperty(this,"_isOnline",{value:e}),Object.defineProperty(this,"_browserFetch",{value:n}),Object.defineProperty(this,"_cache",{value:t})}function o(e){return"stop"===(e=e||{}).action}function i(e,t){var r,s,o,i,u,c=[];e instanceof Array||(e=[e]);var l=e.length,f=function(a){if(!(a<l))return Promise.resolve();if(o=e[a].storeName,s=e[a].operation,i=e[a].undoRedoData,"upsert"==s||"remove"==s&&t){for(c=[],u=i.length,r=0;r<u;r++)t?c.push({key:i[r].key,value:i[r].undo}):c.push({key:i[r].key,value:i[r].redo});return n.openStore(o).then(function(e){return 1==c.length&&null==c[0].value&&null!=c[0].key?e.removeByKey(c[0].key).then(function(){return f(++a)}):e.upsertAll(c).then(function(){return f(++a)})})}return"remove"==s?n.openStore(o).then(function(e){return e.removeByKey(i[0].key).then(function(){return f(++a)})}):void 0};return f(0)}function u(e,n,t,r){return function e(n,t){if(t.length>0)return t[0].listener(n).then(function(n){return null!=n?Promise.resolve(n):t.length>1?e(t.slice(1)):void 0});return Promise.resolve(null)}(t,e._eventListeners.filter(function(e,n){return function(t){return e.toLowerCase()==t.type&&(null!=n&&n.match(t.scope)||null==n||null==t.scope)}}(n,r)))}function c(e){return n.openStore(e,{index:["metadata.created"]})}function l(){return c("syncLog")}function f(){return c("redoUndoLog")}return s.prototype.addEventListener=function(e,n,t){r.log("Offline Persistence Toolkit PersistenceSyncManager: addEventListener() for type: "+e+" and scope: "+t),this._eventListeners.push({type:e.toLowerCase(),listener:n,scope:t})},s.prototype.removeEventListener=function(e,n,t){r.log("Offline Persistence Toolkit PersistenceSyncManager: removeEventListener() for type: "+e+" and scope: "+t),this._eventListeners=this._eventListeners.filter(function(r){return e.toLowerCase()!=r.type||n!=r.listener||t!=r.scope})},s.prototype.getSyncLog=function(){var n;return r.log("Offline Persistence Toolkit PersistenceSyncManager: getSyncLog()"),this._readingSyncLog||(this._readingSyncLog=(n=this,l().then(function(e){return e.find(function(){var e={},n=[],t=[];t.push("metadata.created"),e.sort=t,n.push("metadata.created"),n.push("value"),e.fields=n;var r={},s={$exists:!0};return r["metadata.created"]=s,e.selector=r,e}())}).then(function(n){return function(n){var t,r,s=[],o=function(n){return n&&0!=n.length?(t=n[0].metadata.created.toString(),r=n[0].value,e.requestFromJSON(r).then(function(e){return s.push(function(e,n){return{requestId:e,request:n,undo:function(){return function(e){return f().then(function(n){return n.findByKey(e)}).then(function(e){return null!=e&&i(e,!0).then(function(){return!0})})}(e)},redo:function(){return function(e){return f().then(function(n){return n.findByKey(e)}).then(function(e){return null!=e&&i(e,!1).then(function(){return!0})})}(e)}}}(t,e)),n.shift(),o(n)})):Promise.resolve(s)};return o(n)}(n)}).then(function(e){return n._readingSyncLog=null,e}))),this._readingSyncLog},s.prototype.insertRequest=function(n,s){r.log("Offline Persistence Toolkit PersistenceSyncManager: insertRequest() for Request with url: "+n.url);var o={};return l().then(function(t){return o.store=t,e.requestToJSON(n,{_noClone:!0})}).then(function(e){return o.requestData=e,o.metadata=t.constructMetadata(n),o.requestId=o.metadata.created.toString(),o.store.upsert(o.requestId,o.metadata,o.requestData)}).then(function(){if(null!=s){var e=s.undoRedoDataArray;return null!=e?f().then(function(n){var t=function(r){return r<e.length&&null!=e[r]?n.upsert(o.requestId,o.metadata,e[r]).then(function(){return t(++r)}):Promise.resolve()};return t(0)}):Promise.resolve()}return Promise.resolve()})},s.prototype.removeRequest=function(e){r.log("Offline Persistence Toolkit PersistenceSyncManager: removeRequest() for Request with requestId: "+e);var n=this,t={};return l().then(function(r){return t.store=r,function(e,n){return e.getSyncLog().then(function(e){var t,r=e.length;for(t=0;t<r;t++)if(e[t].requestId===n)return e[t].request})}(n,e)}).then(function(n){return t.request=n,t.store.removeByKey(e)}).then(function(){return f()}).then(function(n){return n.removeByKey(e)}).then(function(){return t.request})},s.prototype.updateRequest=function(n,s){return r.log("Offline Persistence Toolkit PersistenceSyncManager: updateRequest() for Request with requestId: "+n),Promise.all([l(),e.requestToJSON(s)]).then(function(e){var r=e[0],o=e[1],i=t.constructMetadata(s);return r.upsert(n,i,o)})},s.prototype.sync=function(n){r.log("Offline Persistence Toolkit PersistenceSyncManager: sync()"),this._options=n||{};var t=this;return this._syncing?Promise.reject("Cannot start sync while sync is in progress"):(this._syncing=!0,new Promise(function(n,s){t.getSyncLog().then(function(i){if(t._isOnline()){var c,l,f;r.log("Offline Persistence Toolkit PersistenceSyncManager: Processing sync, is online");var a=function(i){0==i.length&&(r.log("Offline Persistence Toolkit PersistenceSyncManager: Sync finished, no requests in sync log"),n()),i.length>0&&(r.log("Offline Persistence Toolkit PersistenceSyncManager: Processing sync, # of request in sync log: "+i.length),c=i[0].requestId,l=i[0].request,f=l.clone(),r.log("Offline Persistence Toolkit PersistenceSyncManager: Dispatching beforeSyncRequest event"),u(t,"beforeSyncRequest",{requestId:c,request:f.clone()},l.url).then(function(h){if(o(h))return r.log("Offline Persistence Toolkit PersistenceSyncManager: Sync stopped by beforeSyncRequest event listener"),void n();"skip"!==(h=h||{}).action?("replay"===h.action&&(r.log("Offline Persistence Toolkit PersistenceSyncManager: Replay request from beforeSyncRequest event listener"),l=h.request),f=l.clone(),function(e,n){var t=e,s=t._options.preflightOptionsRequest,o=t._options.preflightOptionsRequestTimeout;if(null!=n.url&&"disabled"!=s&&null!=n.url.match(s)){if(r.log("Offline Persistence Toolkit PersistenceSyncManager: Checking URL based on preflightOptionsRequest"),t._pingedURLs){if(t._pingedURLs.indexOf(n.url)>=0)return Promise.resolve(!0)}else t._pingedURLs=[];return t._preflightOptionsRequestId=(new Date).getTime(),new Promise((i=t._preflightOptionsRequestId,function(e,r){t._repliedOptionsRequest=!1;var s=new Request(n.url,{method:"OPTIONS"}),u=6e4;null!=o&&(u=o),setTimeout(function(){t._repliedOptionsRequest||t._preflightOptionsRequestId!=i||r(!1)},u),t._browserFetch(s).then(function(r){t._repliedOptionsRequest=!0,t._pingedURLs||(t._pingedURLs=[]),t._pingedURLs.push(n.url),e(!0)},function(n){t._repliedOptionsRequest=!0,e(!0)})}))}var i;return Promise.resolve(!0)}(t,l).then(function(){r.log("Offline Persistence Toolkit PersistenceSyncManager: Replaying request with url: "+l.url),t._browserFetch(l).then(function(h){h.status>=400?s({error:h.statusText,requestId:c,request:f.clone(),response:h.clone()}):e._cloneResponse(h,{url:l.url}).then(function(h){r.log("Offline Persistence Toolkit PersistenceSyncManager: Dispatching syncRequest event"),u(t,"syncRequest",{requestId:c,request:f.clone(),response:h.clone()},l.url).then(function(u){o(u)?n():(r.log("Offline Persistence Toolkit PersistenceSyncManager: Removing replayed request"),t.removeRequest(c).then(function(){i.shift(),"GET"==l.method||"HEAD"==l.method?e._cloneResponse(h,{url:l.url}).then(function(e){t._cache().put(l,e).then(function(){r.log("Offline Persistence Toolkit PersistenceSyncManager: Replayed request/response is cached."),a(i)})}):a(i)},function(e){s({error:e,requestId:c,request:f.clone()})}))})})},function(e){s({error:e,requestId:c,request:f.clone()})})},function(e){if(!1===e){s({error:"Preflight OPTIONS request timed out",requestId:c,request:f.clone(),response:new Response(null,{status:504,statusText:"Preflight OPTIONS request timed out"})})}else s({error:e,requestId:c,request:f.clone()})})):(r.log("Offline Persistence Toolkit PersistenceSyncManager: Removing skipped request"),t.removeRequest(c).then(function(){i.shift(),a(i)},function(e){s({error:e,requestId:c,request:f.clone()})}))}))};i=function(e){if(e&&e.length>0){var n,t,r=[];for(n=0;n<e.length;n++)"GET"!=(t=e[n].request).method&&"HEAD"!=t.method&&r.push(e[n]);for(n=0;n<e.length;n++)"GET"!=(t=e[n].request).method&&"HEAD"!=t.method||r.push(e[n]);return r}return e}(i),a(i)}else n()})}).then(function(e){return t._syncing=!1,t._pingedURLs=null,e},function(e){return t._syncing=!1,t._pingedURLs=null,Promise.reject(e)}))},s});