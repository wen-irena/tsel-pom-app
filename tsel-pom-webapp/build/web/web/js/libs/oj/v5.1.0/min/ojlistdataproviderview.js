"use strict";define(["ojs/ojcore","jquery","ojs/ojcomponentcore","ojs/ojeventtarget","ojs/ojdataprovider"],function(t,e){var i=function(){function e(t,e){this.dataProvider=t,this.options=e,this._KEY="key",this._KEYS="keys",this._DATA="data",this._STARTINDEX="startIndex",this._SORT="sort",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._METADATA="metadata",this._FROM="from",this._OFFSET="offset",this._REFRESH="refresh",this._MUTATE="mutate",this._SIZE="size",this._FETCHPARAMETERS="fetchParameters",this._VALUE="value",this._DONE="done",this._DATAMAPPING="dataMapping",this._MAPFIELDS="mapFields",this._MAPSORTCRITERIA="mapSortCriteria",this._MAPFILTERCRITERION="mapFilterCriterion",this._UNMAPSORTCRITERIA="mapSortCriteria",this._RESULTS="results",this._CONTAINSPARAMETERS="containsParameters",this._DEFAULT_SIZE=25,this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._FETCHFIRST="fetchFirst",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=function(t,e){this._parent=t,this._asyncIterator=e,this[Symbol.asyncIterator]=function(){return this._asyncIterator}},this.AsyncIterator=function(){function t(t,e,i){this._parent=t,this._nextFunc=e,this._params=i}return t.prototype.next=function(){var t=this._nextFunc(this._params);return Promise.resolve(t)},t}(),this.AsyncIteratorResult=function(t,e,i){this._parent=t,this.value=e,this.done=i,this[t._VALUE]=e,this[t._DONE]=i},this.FetchListResult=function(t,e,i,s){this._parent=t,this.fetchParameters=e,this.data=i,this.metadata=s,this[t._FETCHPARAMETERS]=e,this[t._DATA]=i,this[t._METADATA]=s},this.Item=function(t,e,i){this._parent=t,this.metadata=e,this.data=i,this[t._METADATA]=e,this[t._DATA]=i},this.ItemMetadata=function(t,e){this._parent=t,this.key=e,this[t._KEY]=e},this.FetchListParameters=function(t,e,i,s){this._parent=t,this.size=e,this.sortCriteria=i,this.filterCriterion=s,this[t._SIZE]=e,this[t._SORTCRITERIA]=i,this[t._FILTERCRITERION]=s},this.FetchByOffsetParameters=function(t,e,i,s,n){this._parent=t,this.offset=e,this.size=i,this.sortCriteria=s,this.filterCriterion=n,this[t._SIZE]=i,this[t._SORTCRITERIA]=s,this[t._OFFSET]=e,this[t._FILTERCRITERION]=n},this.FetchByKeysResults=function(t,e,i){this._parent=t,this.fetchParameters=e,this.results=i,this[t._FETCHPARAMETERS]=e,this[t._RESULTS]=i},this.ContainsKeysResults=function(t,e,i){this._parent=t,this.containsParameters=e,this.results=i,this[t._CONTAINSPARAMETERS]=e,this[t._RESULTS]=i},this[this._FROM]=null==this.options?null:this.options[this._FROM],this[this._OFFSET]=null==this.options?0:this.options[this._OFFSET]>0?this.options[this._OFFSET]:0,this[this._SORTCRITERIA]=null==this.options?null:this.options[this._SORTCRITERIA],this[this._DATAMAPPING]=null==this.options?null:this.options[this._DATAMAPPING],this._addEventListeners(t)}return e.prototype.containsKeys=function(t){var e=this;return this.dataProvider[e._CONTAINSKEYS]?this.dataProvider[e._CONTAINSKEYS](t):this.fetchByKeys(t).then(function(i){var s=new Set;return t[e._KEYS].forEach(function(t){null!=i[e._RESULTS].get(t)&&s.add(t)}),Promise.resolve(new e.ContainsKeysResults(e,t,s))})},e.prototype.fetchByKeys=function(t){var e=this;if(this.dataProvider[e._FETCHBYKEYS])return this.dataProvider[e._FETCHBYKEYS](t).then(function(i){var s=i[e._RESULTS],n=new Map;return s.forEach(function(t,i){var s=e._getMappedItems([t]);n.set(i,s[0])}),new e.FetchByKeysResults(e,t,n)});var i={};i[this._SIZE]=this._DEFAULT_SIZE;var s=new Map,n=this.dataProvider[e._FETCHFIRST](i)[Symbol.asyncIterator]();return this._fetchNextSet(t,n,s).then(function(i){var s=new Map;return i.forEach(function(t,i){var n=e._getMappedItems([t]);s.set(i,n[0])}),new e.FetchByKeysResults(e,t,s)})},e.prototype.fetchFirst=function(e){var i={};i[this._DATA]=[],i[this._KEYS]=[],i[this._DONE]=!1,i[this._STARTINDEX]=0;var s=null!=e?e[this._SIZE]:null,n=null!=e?e[this._SORTCRITERIA]:null;null==n&&(n=this[this._SORTCRITERIA]);var r=this._getMappedSortCriteria(n),h=null!=e?e[this._FILTERCRITERION]:null,a=this._getMappedFilterCriterion(h),_=this;if(null==_[this._FROM]&&_[this._OFFSET]>0&&t.DataProviderFeatureChecker.isFetchByOffset(_.dataProvider)){var o=_[this._OFFSET];return new this.AsyncIterable(this,new this.AsyncIterator(this,function(t){return function(){var e=new _.FetchByOffsetParameters(_,o,s,r,a);return _.dataProvider[_._FETCHBYOFFSET](e).then(function(e){var i=e.results,n=i.map(function(t){return t[_._DATA]}),r=(i.map(function(t){return t[_._METADATA]}),i.map(function(t){return t[_._METADATA][_._KEY]}));o+=r.length;var h=_._getMappedDataAndKeys(r,n);_._cacheResult(t,h[_._DATA],h[_._KEYS]),t[_._DONE]=e[_._DONE];var a=e[_._FETCHPARAMETERS],A=null!=a?a[_._SORTCRITERIA]:null,E=_._getUnmappedSortCriteria(A),u=new _.FetchByOffsetParameters(_,_[_._OFFSET],s,E);return Promise.resolve(new _.AsyncIteratorResult(_,new _.FetchListResult(_,u,h[_._DATA],h[_._METADATA]),t[_._DONE]))})}}(i),e))}var A=new this.FetchListParameters(this,s,r,a),E=this.dataProvider[_._FETCHFIRST](A)[Symbol.asyncIterator]();return new this.AsyncIterable(this,new this.AsyncIterator(this,function(t,i){return function(){return i.next().then(function(s){var n=s[_._VALUE][_._DATA],r=s[_._VALUE][_._METADATA],h=r.map(function(t){return t[_._KEY]}),a=(n.map(function(t,e){return new _.Item(_,r[e],n[e])}),_._getMappedDataAndKeys(h,n));_._cacheResult(t,a[_._DATA],a[_._KEYS]),t[_._DONE]=s[_._DONE];var o=null!=e?e[_._SIZE]:null,A=(null!=e&&e[_._OFFSET],s[_._VALUE][_._FETCHPARAMETERS]),E=null!=A?A[_._SORTCRITERIA]:null,u=_._getUnmappedSortCriteria(E),T=new _.FetchListParameters(_,o,u);return _._fetchUntilKey(T,_[_._FROM],t,i).then(function(){return _._fetchUntilOffset(T,_[_._OFFSET]+t[_._STARTINDEX],n.length,t,i)})})}}(i,E),e))},e.prototype.getCapability=function(t){return this.dataProvider.getCapability(t)},e.prototype.getTotalSize=function(){return this.dataProvider.getTotalSize()},e.prototype.isEmpty=function(){return this.dataProvider.isEmpty()},e.prototype._fetchNextSet=function(e,i,s){var n=this;return i.next().then(function(r){var h=r[n._VALUE],a=h[n._DATA],_=h[n._METADATA],o=_.map(function(t){return t[n._KEY]}),A=!0;return e[n._KEYS].forEach(function(e){s.has(e)||o.map(function(i,r){t.Object.compareValues(i,e)&&s.set(e,new n.Item(n,_[r],a[r]))}),s.has(e)||(A=!1)}),A||r[n._DONE]?s:n._fetchNextSet(e,i,s)})},e.prototype._fetchUntilKey=function(t,e,i,s){var n=this;if(null!=e){var r=i[this._KEYS].filter(function(t){if(e==t)return!0});if(r.length>0){var h=i[this._KEYS].indexOf(r[0]);i[this._KEYS]=i[this._KEYS].slice(h,i[this._KEYS].length),i[this._DATA]=i[this._DATA].slice(h,i[this._DATA].length)}else{if(!i[n._DONE])return s.next().then(function(t){var e=t[n._VALUE][n._DATA],r=t[n._VALUE][n._METADATA].map(function(t){return t[n._KEY]}),h=n._getMappedDataAndKeys(r,e);return n._cacheResult(i,h[n._DATA],h[n._KEYS]),i[n._DONE]=t[n._DONE],n._fetchUntilKey(t[n._FETCHPARAMETERS],h[n._KEYS],i,s)});i[this._DATA]=[],i[this._KEYS]=[]}}return Promise.resolve(null)},e.prototype._fetchUntilOffset=function(t,e,i,s,n){var r=this,h=null!=t&&t[this._SIZE]>0?t[this._SIZE]:i;e=e>0?e:0;var a=s[this._KEYS].slice(e,e+h),_=s[this._DATA].slice(e,e+h),o=a.map(function(t){return new r.ItemMetadata(r,t)});return _.length<h?s[r._DONE]?(s[this._STARTINDEX]=s[this._STARTINDEX]+_.length,Promise.resolve(new r.AsyncIteratorResult(r,new r.FetchListResult(r,t,_,o),!0))):n.next().then(function(t){var i=t[r._VALUE][r._DATA],h=t[r._VALUE][r._METADATA].map(function(t){return t[r._KEY]}),a=r._getMappedDataAndKeys(h,i);return r._cacheResult(s,a[r._DATA],a[r._KEYS]),s[r._DONE]=t[r._DONE],r._fetchUntilOffset(t[r._VALUE][r._FETCHPARAMETERS],e,i.length,s,n)}):(s[this._STARTINDEX]=s[this._STARTINDEX]+_.length,Promise.resolve(new r.AsyncIteratorResult(r,new r.FetchListResult(r,t,_,o),s[r._DONE])))},e.prototype._cacheResult=function(t,e,i){var s=this;e.map(function(e){t[s._DATA].push(e)}),i.map(function(e){t[s._KEYS].push(e)})},e.prototype._getMappedItems=function(t){var e=this;if(null!=this[this._DATAMAPPING]){var i=this[this._DATAMAPPING][this._MAPFIELDS];if(null!=i&&null!=t&&t.length>0)return new Array,t.map(function(t){return i.bind(e)(t)})}return t},e.prototype._getMappedDataAndKeys=function(t,e){var i=this,s=e.map(function(s,n){return new i.Item(i,new i.ItemMetadata(i,t[n]),e[n])}),n=this._getMappedItems(s),r=n.map(function(t){return t[i._DATA]}),h=n.map(function(t){return t[i._METADATA][i._KEY]}),a=n.map(function(t){return t[i._METADATA]}),_={};return _[this._DATA]=r,_[this._KEYS]=h,_[this._METADATA]=a,_},e.prototype._getMappedFilterCriterion=function(t){if(null!=this[this._DATAMAPPING]){var e=this[this._DATAMAPPING][this._MAPFILTERCRITERION];if(null!=e&&null!=t)return e(t)}return t},e.prototype._getMappedSortCriteria=function(t){if(null!=this[this._DATAMAPPING]){var e=this[this._DATAMAPPING][this._MAPSORTCRITERIA];if(null!=e&&null!=t&&t.length>0)return e(t)}return t},e.prototype._getUnmappedSortCriteria=function(t){if(null!=this[this._DATAMAPPING]){var e=this[this._DATAMAPPING][this._UNMAPSORTCRITERIA];if(null!=e&&null!=t&&t.length>0)return e(t)}return t},e.prototype._addEventListeners=function(t){var e=this;t[e._ADDEVENTLISTENER](this._REFRESH,function(t){e.dispatchEvent(t)}),t[e._ADDEVENTLISTENER](this._MUTATE,function(t){e.dispatchEvent(t)})},e}();t.ListDataProviderView=i,t.ListDataProviderView=i,t.EventTargetMixin.applyMixin(i),t.FetchByOffsetMixin.applyMixin(i)});