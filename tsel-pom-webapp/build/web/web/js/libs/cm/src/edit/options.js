import{onBlur}from"../display/focus.js";import{setGuttersForLineNumbers,updateGutters}from"../display/gutters.js";import{alignHorizontally}from"../display/line_numbers.js";import{loadMode,resetModeState}from"../display/mode_state.js";import{initScrollbars,updateScrollbars}from"../display/scrollbars.js";import{updateSelection}from"../display/selection.js";import{regChange}from"../display/view_tracking.js";import{getKeyMap}from"../input/keymap.js";import{defaultSpecialCharPlaceholder}from"../line/line_data.js";import{Pos}from"../line/pos.js";import{findMaxLine}from"../line/spans.js";import{clearCaches,compensateForHScroll,estimateLineHeights}from"../measurement/position_measurement.js";import{replaceRange}from"../model/changes.js";import{mobile,windows}from"../util/browser.js";import{addClass,rmClass}from"../util/dom.js";import{off,on}from"../util/event.js";import{themeChanged}from"./utils.js";export let Init={toString:function(){return"CodeMirror.Init"}};export let defaults={};export let optionHandlers={};export function defineOptions(e){let t=e.optionHandlers;function r(r,l,o,a){e.defaults[r]=l,o&&(t[r]=a?(e,t,r)=>{r!=Init&&o(e,t,r)}:o)}e.defineOption=r,e.Init=Init,r("value","",(e,t)=>e.setValue(t),!0),r("mode",null,(e,t)=>{e.doc.modeOption=t,loadMode(e)},!0),r("indentUnit",2,loadMode,!0),r("indentWithTabs",!1),r("smartIndent",!0),r("tabSize",4,e=>{resetModeState(e),clearCaches(e),regChange(e)},!0),r("lineSeparator",null,(e,t)=>{if(e.doc.lineSep=t,!t)return;let r=[],l=e.doc.first;e.doc.iter(e=>{for(let o=0;;){let a=e.text.indexOf(t,o);if(-1==a)break;o=a+t.length,r.push(Pos(l,a))}l++});for(let l=r.length-1;l>=0;l--)replaceRange(e.doc,t,r[l],Pos(r[l].line,r[l].ch+t.length))}),r("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,(e,t,r)=>{e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Init&&e.refresh()}),r("specialCharPlaceholder",defaultSpecialCharPlaceholder,e=>e.refresh(),!0),r("electricChars",!0),r("inputStyle",mobile?"contenteditable":"textarea",()=>{throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),r("spellcheck",!1,(e,t)=>e.getInputField().spellcheck=t,!0),r("rtlMoveVisually",!windows),r("wholeLineUpdateBefore",!0),r("theme","default",e=>{themeChanged(e),guttersChanged(e)},!0),r("keyMap","default",(e,t,r)=>{let l=getKeyMap(t),o=r!=Init&&getKeyMap(r);o&&o.detach&&o.detach(e,l),l.attach&&l.attach(e,o||null)}),r("extraKeys",null),r("configureMouse",null),r("lineWrapping",!1,wrappingChanged,!0),r("gutters",[],e=>{setGuttersForLineNumbers(e.options),guttersChanged(e)},!0),r("fixedGutter",!0,(e,t)=>{e.display.gutters.style.left=t?compensateForHScroll(e.display)+"px":"0",e.refresh()},!0),r("coverGutterNextToScrollbar",!1,e=>updateScrollbars(e),!0),r("scrollbarStyle","native",e=>{initScrollbars(e),updateScrollbars(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),r("lineNumbers",!1,e=>{setGuttersForLineNumbers(e.options),guttersChanged(e)},!0),r("firstLineNumber",1,guttersChanged,!0),r("lineNumberFormatter",e=>e,guttersChanged,!0),r("showCursorWhenSelecting",!1,updateSelection,!0),r("resetSelectionOnContextMenu",!0),r("lineWiseCopyCut",!0),r("pasteLinesPerSelection",!0),r("readOnly",!1,(e,t)=>{"nocursor"==t&&(onBlur(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),r("disableInput",!1,(e,t)=>{t||e.display.input.reset()},!0),r("dragDrop",!0,dragDropChanged),r("allowDropFileTypes",null),r("cursorBlinkRate",530),r("cursorScrollMargin",0),r("cursorHeight",1,updateSelection,!0),r("singleCursorHeightPerLine",!0,updateSelection,!0),r("workTime",100),r("workDelay",100),r("flattenSpans",!0,resetModeState,!0),r("addModeClass",!1,resetModeState,!0),r("pollInterval",100),r("undoDepth",200,(e,t)=>e.doc.history.undoDepth=t),r("historyEventDelay",1250),r("viewportMargin",10,e=>e.refresh(),!0),r("maxHighlightLength",1e4,resetModeState,!0),r("moveInputWithCursor",!0,(e,t)=>{t||e.display.input.resetPosition()}),r("tabindex",null,(e,t)=>e.display.input.getField().tabIndex=t||""),r("autofocus",null),r("direction","ltr",(e,t)=>e.doc.setDirection(t),!0),r("phrases",null)};function guttersChanged(e){updateGutters(e),regChange(e),alignHorizontally(e)}function dragDropChanged(e,t,r){if(!t!=!(r&&r!=Init)){let r=e.display.dragFunctions,l=t?on:off;l(e.display.scroller,"dragstart",r.start),l(e.display.scroller,"dragenter",r.enter),l(e.display.scroller,"dragover",r.over),l(e.display.scroller,"dragleave",r.leave),l(e.display.scroller,"drop",r.drop)}}function wrappingChanged(e){e.options.lineWrapping?(addClass(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(rmClass(e.display.wrapper,"CodeMirror-wrap"),findMaxLine(e)),estimateLineHeights(e),regChange(e),clearCaches(e),setTimeout(()=>updateScrollbars(e),100)}